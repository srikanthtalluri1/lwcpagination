@IsTest
private class technologyDecision_CreateFormHelperTest {

    // Helper to build the map for the TechnologyDecision__c side
    private static Map<String, Object> buildDecisionFields() {
        Map<String, Object> decisionFields = new Map<String, Object>();
        // Set only editable / writeable fields (API names)
        decisionFields.put('Name', 'Unit Test Decision');
        decisionFields.put('Stage__c', 'Saved');
        decisionFields.put('Status__c', 'Draft');
        decisionFields.put('Why__c', 'Why text');
        decisionFields.put('What__c', 'What text');
        decisionFields.put('Value__c', 'Value text');

        // If your org has additional required fields on TechnologyDecision__c,
        // add them here with their API names, e.g.:
        // decisionFields.put('Some_Required_Field__c', 'Some value');

        return decisionFields;
    }

    // Helper to build the map for the TechnologyDecision_Relationship__c side
    private static Map<String, Object> buildRelationshipFields() {
        Map<String, Object> relationFields = new Map<String, Object>();
        relationFields.put('Name', 'Unit Test Relation');

        // IMPORTANT:
        // Do NOT try to set relationship fields like TechnologyDecision_Relationship__r.Something
        // or Requesting_Application__r.Name â€“ those are NOT editable.
        // Always set the *lookup Id* field (the __c).
        //
        // Example (if you need these):
        // relationFields.put('Requesting_Domain__c', someDomain.Id);
        // relationFields.put('Requesting_Application__c', someApp.Id);
        //
        // Add any required fields for TechnologyDecision_Relationship__c here.

        return relationFields;
    }

    @IsTest
    static void testCreateDecisionWithRelation_andLink() {
        // Arrange
        Map<String, Object> decisionFields  = buildDecisionFields();
        Map<String, Object> relationFields  = buildRelationshipFields();

        Test.startTest();
        // Act
        String decisionIdStr = technologyDecision_CreateFormHelper.createDecisionWithRelation(
            decisionFields,
            relationFields
        );
        Test.stopTest();

        System.assertNotEquals(null, decisionIdStr, 'Method should return the Decision Id');

        Id decisionId = (Id)decisionIdStr;

        // Assert: Decision exists and is linked to a relationship record
        TechnologyDecision__c dec = [
            SELECT Id, Name, TechnologyDecision_Relationship__c
            FROM TechnologyDecision__c
            WHERE Id = :decisionId
            LIMIT 1
        ];
        System.assertNotEquals(null, dec.TechnologyDecision_Relationship__c,
            'Decision should reference a TechnologyDecision_Relationship__c record');

        TechnologyDecision_Relationship__c rel = [
            SELECT Id, Decison_Id__c
            FROM TechnologyDecision_Relationship__c
            WHERE Id = :dec.TechnologyDecision_Relationship__c
            LIMIT 1
        ];

        System.assertEquals(dec.Id, rel.Decison_Id__c,
            'Relationship record should point back to the Decision via Decison_Id__c');
    }

    @IsTest
    static void testGetDecisionRecord() {
        // Arrange
        TechnologyDecision__c dec = new TechnologyDecision__c(
            Name = 'Get Record Test',
            Stage__c = 'Saved',
            Status__c = 'Draft',
            Why__c = 'Why',
            What__c = 'What',
            Value__c = 'Value'
        );
        insert dec;

        Test.startTest();
        TechnologyDecision__c fetched =
            technologyDecision_CreateFormHelper.getDecisionRecord(dec.Id);
        Test.stopTest();

        System.assertEquals(dec.Id, fetched.Id, 'Should return same record');
        System.assertEquals('Saved', fetched.Stage__c);
        System.assertEquals('Draft', fetched.Status__c);
    }

    @IsTest
    static void testValidateRequiredFieldsOnDecision_SavedMissing() {
        // This decision is missing Why__c / What__c / Value__c to trigger validation
        TechnologyDecision__c dec = new TechnologyDecision__c(
            Name = 'Validation Test',
            Stage__c = 'Saved',
            Status__c = 'Draft'
            // Deliberately NOT setting Why__c, What__c, Value__c
        );
        insert dec;

        Test.startTest();
        String message = technologyDecision_CreateFormHelper.validateRequiredFieldsOnDecision(dec.Id);
        Test.stopTest();

        System.assertNotEquals(
            '',
            message,
            'For Stage=Saved with required fields missing, we should get a validation message'
        );
        System.assert(
            message.contains('Please edit and update all required field(s)'),
            'Message should indicate required fields must be updated'
        );
    }

    @IsTest
    static void testFetchButtonPermissions_PrepareDecisionVisible() {
        // Simulate that the current user has TPM_Read_Write permission
        technologyDecision_CreateFormHelper.permissionSetNames.clear();
        technologyDecision_CreateFormHelper.permissionSetNames.add('TPM_Read_Write');

        // Get whatever employee Id your AWP_Utility returns
        Id empId = AWP_Utility.getLoggedInUserEmpRecordId();

        // Create a decision where the logged-in employee is the Requestor/TA
        TechnologyDecision__c dec = new TechnologyDecision__c(
            Name = 'Button Perm Test',
            Stage__c = 'Saved',
            Status__c = 'Draft',
            Requestor__c = empId,
            Requesting_Technical_Architect__c = empId,
            Why__c = 'Why',
            What__c = 'What',
            Value__c = 'Value'
        );
        insert dec;

        Test.startTest();
        technologyDecision_CreateFormHelper.ButtonPermissions perms =
            technologyDecision_CreateFormHelper.fetchButtonPermissions(dec.Id);
        Test.stopTest();

        // For Stage = Saved and user as Requestor/TA + TPM_Read_Write,
        // prepareDecision button should be enabled.
        System.assertEquals(
            true,
            perms.prepareDecision,
            'prepareDecision button should be allowed for TA/Requestor in Saved stage'
        );

        // Edit is always allowed per code
        System.assertEquals(true, perms.edit, 'edit button should always be true');
    }
}
