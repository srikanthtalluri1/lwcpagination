import { LightningElement, api, wire } from 'lwc';
import fetchRelated from '@salesforce/apex/TechnologyDecision_RelatedListHandler.fetchRelated';
import { NavigationMixin } from 'lightning/navigation';
import { encodeDefaultFieldValues } from 'lightning/pageReferenceUtils';
import { deleteRecord } from 'lightning/uiRecordApi';
import { ShowToastEvent } from 'lightning/platformShowToastEvent';
import { refreshApex } from '@salesforce/apex';

const ROW_ACTIONS = [
    { label: 'Edit', name: 'edit' },
    { label: 'Delete', name: 'delete' }
];

export default class TechnologyDecisionRelatedList extends NavigationMixin(LightningElement) {
    @api recordId;

    records = [];
    wiredResult;

    get cardTitle() {
        return `Stakeholders (${this.records?.length || 0})`;
    }

    columns = [
        // Clickable name like standard related list
        {
            label: 'Name',
            fieldName: 'link',
            type: 'url',
            typeAttributes: {
                label: { fieldName: 'Name' },
                target: '_self'
            }
        },
        { label: 'Created Date', fieldName: 'CreatedDate', type: 'date' },
        { type: 'action', typeAttributes: { rowActions: ROW_ACTIONS } }
    ];

    @wire(fetchRelated, { parentId: '$recordId' })
    wiredData(result) {
        this.wiredResult = result;
        const { data, error } = result;

        if (data) {
            // Add link field for Name column
            this.records = data.map(r => ({
                ...r,
                link: `/${r.Id}`
            }));
        } else if (error) {
            // optional
            // console.error(error);
        }
    }

    handleNew() {
        const defaultValues = encodeDefaultFieldValues({
            Decision__c: this.recordId
        });

        this[NavigationMixin.Navigate]({
            type: 'standard__objectPage',
            attributes: {
                objectApiName: 'TechnologyDecision_StakeHolder__c',
                actionName: 'new'
            },
            state: { defaultFieldValues: defaultValues }
        });
    }

    async handleRowAction(event) {
        const actionName = event.detail.action.name;
        const row = event.detail.row;

        if (actionName === 'edit') {
            // Standard edit modal
            this[NavigationMixin.Navigate]({
                type: 'standard__recordPage',
                attributes: {
                    recordId: row.Id,
                    objectApiName: 'TechnologyDecision_StakeHolder__c',
                    actionName: 'edit'
                }
            });
            return;
        }

        if (actionName === 'delete') {
            const ok = confirm('Are you sure you want to delete this record?');
            if (!ok) return;

            try {
                await deleteRecord(row.Id);
                this.dispatchEvent(
                    new ShowToastEvent({
                        title: 'Deleted',
                        message: 'Stakeholder deleted.',
                        variant: 'success'
                    })
                );
                await refreshApex(this.wiredResult);
            } catch (e) {
                this.dispatchEvent(
                    new ShowToastEvent({
                        title: 'Error',
                        message: e?.body?.message || 'Delete failed.',
                        variant: 'error'
                    })
                );
            }
        }
    }

    // Optional: View All (works only if relationshipApiName is correct)
    handleViewAll() {
        this[NavigationMixin.Navigate]({
            type: 'standard__recordRelationshipPage',
            attributes: {
                recordId: this.recordId,
                objectApiName: 'TechnologyDecision__c',
                relationshipApiName: 'TechnologyDecision_StakeHolders__r', // <-- update this
                actionName: 'view'
            }
        });
    }
}
