<template>
     <div class="datatable-wrapper">
                    <div class="slds-page-header">
                        <div class="slds-page-header__row">
                            <div class="slds-page-header__col-title">
                                <div class="slds-media">
                                    <div class="slds-media__figure">
                                        <lightning-icon icon-name="standard:opportunity" size="medium"></lightning-icon>
                                    </div>
                                    <div class="slds-media__body">
                                        <div class="slds-page-header__name">
                                            <div class="slds-page-header__name-title">
                                                <h1>
                                                    <span>Technology Decision</span>
                                                    <span class="slds-page-header__title slds-truncate"
                                        title="Recently Viewed">{selectedDecisionLabel}</span>
                                                </h1>
                                            </div>
                                        </div>
                                    </div>
                            <template if:false={showRecord}>
                                        <div class="slds-media__body" style="text-align-last: end;">
                                            <div class="slds-page-header__name">
                                                <div class="slds-page-header__name-title">
                                                    <lightning-button variant="neutral" label="New" data-action="newrecord"
                                                        onclick={openModal}>
                                                    </lightning-button>
                                                    <!-- <div class="slds-col slds-var-p-left_small"> -->
                                                    <lightning-button class="slds-var-p-left_small" label="Back To Listview"
                                                        variant="brand" data-action="sharefilter" onclick={handlebacktolistview}>
                                                    </lightning-button>
                                                    <!-- </div> -->
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div>
                                    {totalRecords} items <span style="font-size: 5px; text-align: center">&#9679;</span> Filtered by
                                    {selectedDecisionLabel}
                                </div>
                            </div>
                        </div>
                    </div>
                     
                    <div class="datatable-container">
    <c-custom-datatable-data-type-provider class="slds-table_bordered" key-field="Waiver_Id__c" data={data}
                            columns={columns} hide-checkbox-column show-row-number-column="true" sorted-by={sortByUi}
                            sorted-direction={sortDirection} onsort={handleSort} row-number-offset={rowNumberOffset}
                            onrowaction={handleActions} oncustomtext={handleActions} 
                            is-loading={isLoading} onloadmore={loadMoreData}> 
                            ><!--key-field="Id"-->
                        </c-custom-datatable-data-type-provider>
                        </div>
                    
     </div>
</template>


import { LightningElement, track, api } from 'lwc';
import getTechnologyDecision from '@salesforce/apex/TechnologyDecision_DataTableHandler.getTechnologyDecision';
import { NavigationMixin } from 'lightning/navigation';
import TechnologyDecisionModal from 'c/technologyDecisionModal';
import { refreshApex } from '@salesforce/apex';
export default class TechnologyDecision_DataTable extends NavigationMixin(LightningElement) {

    @track data = [];
    @track error;
    @track sortBy;
    @track sortDirection = 'asc';
    @track isLoading = false;
    @api filters;
    @api selecteddecision ='mydecision';
    @api searchfilters ;
    totalRecords;

    // Pagination support
    offset = 0;
    limit = 5; // batch size
    allDataLoaded = false;

    columns = [
        { label: 'Name',
        sortable: true,
        fieldName: 'recordLink', // URL field
        type: 'url',
        typeAttributes: {
            label: { fieldName: 'Name' }, // Text shown in table
            target: '_self'               // Open in new tab
        }
    },
    {
        label: 'Status(Stage)',
        fieldName: 'statusStage',
        sortable: true,
        type: 'customStatusStage',
        typeAttributes: {},
        cellAttributes: {
            class: 'slds-grid slds-grid_align-spread slds-grid_vertical-align-center slds-truncate'
        }
    },
       // { label: 'Status', fieldName: 'Status__c',sortable: true, type: 'badge' },
        { label: 'Estimated Decision Date', fieldName: 'Estimated_Decision_Date__c',sortable: true, type: 'text' },
        { label: 'Reason', fieldName: 'Decision_Reason__c', type: 'text',sortable: true }
    ];
    // Call Apex imperatively
   
    connectedCallback() {
        this.loadTechnologyDecision();
       
    }
    get selectedDecisionLabel() {
        return this.selecteddecision === 'mydecision' ? 'My Decision' : 'All Decisions';
    }
     @api
    updatefilters(filters) {
        this.filters = filters;
         console.log('filters 44 ', JSON.stringify(this.filters));
         this.loadTechnologyDecision();
    }
    @api
    updateslecteddecision(selecteddecision) {
        this.selecteddecision = selecteddecision;
         console.log('filters 44 ', this.selecteddecision);
         this.loadTechnologyDecision();
    }
    @api
    updatesearchfilters(searchfilters) {
        this.searchfilters = searchfilters;
         console.log('filters 44 ', this.searchfilters);
         this.loadTechnologyDecision();
    }
    @api
    handleResetButton() {
        this.searchfilters = '';
        this.filters=[];
        this.rowOffSet = 0;
    
         console.log('filters 44 ', this.searchfilters);
         this.loadTechnologyDecision();
    }
   handleSort(event) {
    const uiField = event.detail.fieldName;   // column fieldName (e.g. recordLink, statusStage, etc.)
    let backendField = uiField;

    // Map UI field to backend field
    if (uiField === 'recordLink') {
        backendField = 'Name';
    } else if (uiField === 'statusStage') {
        backendField = 'Status__c';
    }

    this.sortBy = backendField;   // used for sorting logic
    this.sortByUi = uiField;      // used for UI arrow
    this.sortDirection = event.detail.sortDirection;

    let cloneData = [...this.data];

    cloneData.sort((a, b) => {
        let valA = a[backendField] ?? '';
        let valB = b[backendField] ?? '';

        // Numeric
        if (!isNaN(valA) && !isNaN(valB)) {
            valA = Number(valA);
            valB = Number(valB);
        }
        // Dates
        else if (this.isDate(valA) && this.isDate(valB)) {
            valA = new Date(valA).getTime();
            valB = new Date(valB).getTime();
        }
        // Strings
        else {
            valA = valA.toString().toLowerCase();
            valB = valB.toString().toLowerCase();
        }

        return this.sortDirection === 'asc'
            ? (valA > valB ? 1 : valA < valB ? -1 : 0)
            : (valA < valB ? 1 : valA > valB ? -1 : 0);
    });

    this.data = cloneData;
}

  

// Utility to detect valid date string
isDate(val) {
    return !isNaN(Date.parse(val));
}

    loadTechnologyDecision(isLoadMore = false) {
        this.isLoading = true;

        getTechnologyDecision({ offsetSize: this.offset, limitSize: this.limit, filters: JSON.stringify(this.filters), allOrMy:this.selecteddecision, searchKey: this.searchfilters })
            .then(result => {
                this.totalRecords = result.decisionRecordsCount;
                console.log('result ', JSON.stringify(result));
                let newData = result.decisionRecords.map(item => {
                    let formattedDate = item.Estimated_Decision_Date__c;
    if (formattedDate) {
        try {
            formattedDate = new Date(formattedDate).toISOString().split('T')[0];
        } catch (e) {
            formattedDate = item.Estimated_Decision_Date__c; // fallback
        }
    }
    return {
        ...item,
        statusStage: {
                        status: item.Status__c,
                        stage: item.Stage__c
                    },
        recordLink: `/lightning/r/TechnologyDecision__c/${item.Id}/view`, // Construct record link
        Estimated_Decision_Date__c: formattedDate
        
        };
    });
    console.log('data ', JSON.stringify(this.data));
        if (isLoadMore) {
                    this.data = [...this.data, ...newData];
                } else {
                    this.data = newData;
                }

                if (newData.length < this.limit) {
                    this.allDataLoaded = true;
                } else {
                    this.offset += this.limit;
                }

                this.isLoading = false;
                this.error = undefined;
            })
            .catch(error => {
                this.error = error;
                this.data = [];
                 this.isLoading = false;
                console.error('Error fetching accounts', error);
            });
    }
    loadMoreData(event) {
        if (this.allDataLoaded) {
            event.target.isLoading = false; // stop spinner
            return;
        }
        this.loadTechnologyDecision(true);
    }
    handlebacktolistview(event){
        const baseUrl = window.location.origin;
        console.log(baseUrl);
        let url =baseUrl+'lightning/n/Decision_Management';
        this[NavigationMixin.Navigate]({
            type: 'standard__navItemPage',
            attributes: {
                apiName: 'Decision_Management'  // Your Lightning App Page name
            }
        });
    }
    async openModal() {
        const result = await TechnologyDecisionModal.open({
            size: 'medium',
            description: 'Create a new Technology Decision',
            label: 'New Decision'
        });

        if (result === 'saved') {
            // Optional: refresh list view or Apex data
            console.log('Decision created successfully, refresh data here.');
        }
    }

}


