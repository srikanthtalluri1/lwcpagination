@isTest
private class TechnologyDecisionTriggerTest {

    /**
     * Helper to create a bare-minimum TechnologyDecision_Relationship__c record.
     * Add any required fields for your org inside this method.
     */
    private static TechnologyDecision_Relationship__c createRelationshipRecord() {
        TechnologyDecision_Relationship__c rel = new TechnologyDecision_Relationship__c();
        // TODO: set any required fields on TechnologyDecision_Relationship__c here.
        insert rel;
        return rel;
    }

    /**
     * Test BEFORE INSERT – covers all Decision_Reason__c branches so the
     * mapping logic is executed for:
     * - New Technology (domain branch)
     * - Replace Application (application branch)
     * - Replace Technology (technology branch)
     * - Replace Platform (platform branch)
     */
    @isTest
    static void testBeforeInsert_AllReasonBranches() {
        // Create one relationship record per branch
        TechnologyDecision_Relationship__c relDomain      = createRelationshipRecord();
        TechnologyDecision_Relationship__c relApp         = createRelationshipRecord();
        TechnologyDecision_Relationship__c relTech        = createRelationshipRecord();
        TechnologyDecision_Relationship__c relPlatform    = createRelationshipRecord();

        List<TechnologyDecision__c> decisionsToInsert = new List<TechnologyDecision__c>();

        // Domain-related (New Technology / New Platform / New Capability / New Application)
        decisionsToInsert.add(new TechnologyDecision__c(
            Name                               = 'Test New Technology',
            TechnologyDecision_Relationship__c = relDomain.Id,
            Decision_Reason__c                 = 'New Technology'
        ));

        // Application-related (Replace Application / Existing Application / Upgrade Application)
        decisionsToInsert.add(new TechnologyDecision__c(
            Name                               = 'Test Replace Application',
            TechnologyDecision_Relationship__c = relApp.Id,
            Decision_Reason__c                 = 'Replace Application'
        ));

        // Technology-related (Replace Technology / Existing Technology / Upgrade Technology)
        decisionsToInsert.add(new TechnologyDecision__c(
            Name                               = 'Test Replace Technology',
            TechnologyDecision_Relationship__c = relTech.Id,
            Decision_Reason__c                 = 'Replace Technology'
        ));

        // Platform-related (Replace Platform / Existing Platform / Upgrade Platform)
        decisionsToInsert.add(new TechnologyDecision__c(
            Name                               = 'Test Replace Platform',
            TechnologyDecision_Relationship__c = relPlatform.Id,
            Decision_Reason__c                 = 'Replace Platform'
        ));

        Test.startTest();
        insert decisionsToInsert;
        Test.stopTest();

        // Reload and do basic assertions
        List<TechnologyDecision__c> inserted = [
            SELECT Id,
                   Name,
                   Decision_Reason__c,
                   Draft_Status_Start_Date__c,
                   Requestor__c,
                   Requesting_Technical_Architect__c,
                   Requesting_Business_Owner__c,
                   Requesting_Application_Owner__c,
                   Requesting_Tech_Fellow__c
            FROM TechnologyDecision__c
            WHERE Id IN :decisionsToInsert
        ];

        System.assertEquals(4, inserted.size(), 'Four TechnologyDecision__c records should be inserted');

        for (TechnologyDecision__c td : inserted) {
            // At minimum, this should always be set by the trigger
            System.assertNotEquals(
                null,
                td.Draft_Status_Start_Date__c,
                'Draft_Status_Start_Date__c should be populated in before insert trigger'
            );

            // Optional: once you seed real related data, you can add asserts per reason:
            // if (td.Decision_Reason__c == 'New Technology') {
            //     System.assertNotEquals(null, td.Requesting_Technical_Architect__c);
            // }
        }
    }

    /**
     * Test AFTER INSERT – verifies that the related
     * TechnologyDecision_Relationship__c gets updated from the decision.
     *
     * Here we use a Decision_Reason__c that does NOT hit any of the
     * mapping branches so that we can directly control the Requesting_*
     * fields on the TechnologyDecision__c from the test, if needed.
     */
    @isTest
    static void testAfterInsert_RelationshipUpdated() {
        TechnologyDecision_Relationship__c rel = createRelationshipRecord();

        // NOTE:
        // If Requesting_* fields are lookups, you can create one appropriate
        // parent record (e.g., Employee__c) and use that Id below.
        TechnologyDecision__c td = new TechnologyDecision__c(
            Name                               = 'Test After Insert Update',
            TechnologyDecision_Relationship__c = rel.Id,
            Decision_Reason__c                 = 'Other' // does not match any mapping block
            // Optionally pre-populate:
            // Requesting_Technical_Architect__c = someEmp.Id,
            // Requesting_Business_Owner__c      = someEmp.Id,
            // Requesting_Application_Owner__c   = someEmp.Id,
            // Requesting_Tech_Fellow__c         = someEmp.Id
        );

        Test.startTest();
        insert td;
        Test.stopTest();

        // Verify the relationship record exists and was touched by the trigger
        TechnologyDecision_Relationship__c updatedRel = [
            SELECT Id,
                   Requesting_Technical_Architect__c,
                   Requesting_Business_Owner__c,
                   Requesting_Application_Owner__c,
                   Requesting_Portfolio_Architect__c,
                   Requesting_Tech_Fellow__c
            FROM TechnologyDecision_Relationship__c
            WHERE Id = :rel.Id
        ];

        System.assertNotEquals(null, updatedRel.Id, 'Relationship record should exist');

        // If you pre-populated Requesting_* on TechnologyDecision__c above,
        // you can assert those values here, e.g.:
        //
        // System.assertEquals(td.Requesting_Technical_Architect__c,
        //                     updatedRel.Requesting_Technical_Architect__c);
        // System.assertEquals(td.Requesting_Business_Owner__c,
        //                     updatedRel.Requesting_Business_Owner__c);
        // System.assertEquals(td.Requesting_Application_Owner__c,
        //                     updatedRel.Requesting_Application_Owner__c);
        // System.assertEquals(td.Requesting_Tech_Fellow__c,
        //                     updatedRel.Requesting_Tech_Fellow__c);
    }

    /**
     * Optional: test insert without relationship, to ensure the trigger
     * safely skips logic when TechnologyDecision_Relationship__c is null.
     */
    @isTest
    static void testInsertWithoutRelationship() {
        TechnologyDecision__c td = new TechnologyDecision__c(
            Name               = 'No Relationship',
            Decision_Reason__c = 'New Technology'
        );

        Test.startTest();
        insert td;
        Test.stopTest();

        TechnologyDecision__c inserted = [
            SELECT Id, Draft_Status_Start_Date__c
            FROM TechnologyDecision__c
            WHERE Id = :td.Id
        ];
        System.assertNotEquals(
            null,
            inserted.Draft_Status_Start_Date__c,
            'Draft_Status_Start_Date__c should still be set even without relationship'
        );
    }
}
