public Without sharing class technologyDecision_CreateFormHelper {
    static final String DECISION_OBJ = 'TechnologyDecision__c';
    public static Id userId = UserInfo.getUserId();
    public static List<PermissionSetAssignment> psaList = [SELECT PermissionSet.Name FROM PermissionSetAssignment WHERE AssigneeId = :userId ];
    public static List<String> permissionSetNames = new List<String>();
    static final List<String> saveRequiredFields = new List<String> {'Why__c','What__c','Value__c'}; 
    static final List<String> prepareReqFields = new List<String>{'Research_Notes__c','Research_Link__c','Decision_Summary__c','Decision_Notes__c'};
    static final List<String> securityReviewReqFields = new List<String>{'Security_Link__c','Security_Notes__c'};
    public static Set<String> decisionReassignStages = new Set<String> {'Saved','Pending Acknowledgment with AO','Pending Acknowledgment with BO','Pending Acknowledgment with TA','Pending Acknowledgment with Portfolio Architect','Pending Approval with Tech Fellow'};
    Static final Set<String> fieldValidation = new Set<String>();
    @AuraEnabled
    public static String createDecisionWithRelation(Map<String, Object> decisionFields, 
                                                Map<String, Object> relationFields) {
       
    
        // Create TechnologyDecision_Relationship__c record
        TechnologyDecision_Relationship__c relation = (TechnologyDecision_Relationship__c)
            populateFields(new TechnologyDecision_Relationship__c(), relationFields);
        insert relation;
                                                    
           // Create TechnologyDecision__c record
        TechnologyDecision__c decision = (TechnologyDecision__c)
            populateFields(new TechnologyDecision__c(), decisionFields);
         // link relation to decision (adjust field name!)
         decision.TechnologyDecision_Relationship__c = relation.Id;
            try{
                insert decision;

            }
            catch(Exception e){
                system.debug('error is 13:' + e.getMessage());
                return e.getMessage();
            }
        
           relation.Decison_Id__c = decision.Id;
           update relation;
          return decision.Id;
        
         
    }

    // Helper to populate sObject fields dynamically
    private static sObject populateFields(sObject record, Map<String, Object> fieldMap) {
        for (String fieldName : fieldMap.keySet()) {
            try {
                 System.debug('33' + fieldName);
                System.debug('34' + fieldMap);
                record.put(fieldName, fieldMap.get(fieldName));
                
            } catch (Exception e) {
                System.debug('Skipping field ' + fieldName + ': ' + e.getMessage());
            }
        }
        /*if(!record.keySet().contains('Name')){
            record.put('Name', 'test');
        } */
        system.debug('41' + record);
        return record;
        
    }
    
    @AuraEnabled
    public static TechnologyDecision__c getDecisionRecord(Id recordId) {
        try {
            TechnologyDecision__c decision = [
                SELECT Id, Name, Stage__c, Status__c
                FROM TechnologyDecision__c
                WHERE Id = :recordId
                LIMIT 1
            ];
            return decision;
        } catch (Exception e) {
            throw new AuraHandledException('Error fetching record: ' + e.getMessage());
        }
    }
    
    @AuraEnabled
    public static String validateRequiredFieldsOnDecision(String recordId){
        String ValidationMessage = '';
        TechnologyDecision__c decisionRec;
        Map<String, String> fieldApiLabelMap = TechnologyDecision_Utility.getApiAndLabelMap(DECISION_OBJ);
        if(recordId != null){
            decisionRec = [select id,Why__c,What__c,Value__c,Decision_Reason__c,Stage__c,Status__c,Research_Notes__c,Research_Link__c,Decision_Summary__c,Decision_Notes__c,
                           Security_Link__c,Security_Notes__c,Security_Review__c from TechnologyDecision__c where Id = :recordId];
        }
        system.debug('near validate message');
        if(decisionRec.Stage__c == 'Saved'){
            for(string savefieds :saveRequiredFields){
                if (String.isBlank(String.valueOf(decisionRec.get(savefieds)))){
                    fieldValidation.add(savefieds);
                }
            }
            if (!fieldValidation.isEmpty()) {
                ValidationMessage += 'Please edit and update all required field(s) before submitting the Decision for Preparing Decision';
            }
        }
        if(decisionRec.Stage__c == 'Preparing Decision'){ 
            for(string savefieds :prepareReqFields){
                if (String.isBlank(String.valueOf(decisionRec.get(savefieds)))){
                    fieldValidation.add(savefieds);
                }
            }
            if (!fieldValidation.isEmpty()) {
                ValidationMessage += 'Please edit and update all required field(s) before submitting the Decision for Security Review';
            }
        }
        if(decisionRec.Stage__c == 'Security Review'){ 
            for(string savefieds :securityReviewReqFields){
                if (String.isBlank(String.valueOf(decisionRec.get(savefieds)))){
                    fieldValidation.add(savefieds);
                }
            }
            if (!fieldValidation.isEmpty()) {
                ValidationMessage += 'Please edit and update all required field(s) before Security Review Acknowledgement';
            }
        }
        
        system.debug('Validate message :'+ValidationMessage);
      /*  if (String.isNotEmpty(ValidationMessage)) {
                ValidationMessage = ValidationMessage.substring(2);
                ValidationMessage = 'Please update ' + ValidationMessage + ' required field(s) before submitting the waiver for Acknowledgement';
            }*/
        system.debug('Validation message'+ValidationMessage);
        return ValidationMessage;
        
    }
    
    public class ButtonPermissions {
    @AuraEnabled
    public boolean prepareDecision;
    @AuraEnabled
    public boolean securityReview;
    @AuraEnabled
    public boolean submitForApproval;
    @AuraEnabled
    public boolean acknowledge;
    @AuraEnabled
    public boolean Withdraw;
    @AuraEnabled
    public boolean approve;
    @AuraEnabled
    public boolean sendback;
    @AuraEnabled
    public boolean recall;
    @AuraEnabled
    public boolean reject;
    @AuraEnabled
    public boolean retire;
    @AuraEnabled
    public boolean edit;
    @AuraEnabled
    public boolean reAssign;
  }
    
    @AuraEnabled
    public static ButtonPermissions fetchButtonPermissions(String recordId) {
        
        Id loginuserEmpID = AWP_Utility.getLoggedInUserEmpRecordId();
        ButtonPermissions res = new ButtonPermissions();
        List <TechnologyDecision__c> TDecisionRec = new List <TechnologyDecision__c>();
        for (PermissionSetAssignment psa : psaList) {
            permissionSetNames.add(psa.PermissionSet.Name);
        }
        try {
            if(recordId != null){
                TDecisionRec = [select id,Status__c,Stage__c,Requesting_Technical_Architect__c,Requesting_Business_Owner__c,Requesting_Application_Owner__c,Requesting_Tech_Fellow__c,
                             Requestor__c,AO_Acknowledged__c,BO_Acknowledged__c,TA_Acknowledged__c,Security_Review_Acknowledged__c,ReAssigned_BO_Ack__c,ReAssigned_AO_Ack__c,ReAssigned_TA_Ack__c,ReAssigned_Tech_Fellow__c
                             from TechnologyDecision__c where Id = :recordId limit 1];
            }
            system.debug(TDecisionRec + ' @@ '+permissionSetNames);
            if(TDecisionRec.size()>0 && permissionSetNames.contains('TPM_Read_Write')){
                // prepareDecision button permissions
                if((TDecisionRec[0].Requestor__c == loginuserEmpID || TDecisionRec[0].Requesting_Technical_Architect__c == loginuserEmpID) && TDecisionRec[0].Stage__c == 'Saved'){
                    res.prepareDecision = true;
                }
                //Security Review Buttom permissions
                if(TDecisionRec[0].Requesting_Technical_Architect__c == loginuserEmpID && TDecisionRec[0].Stage__c == 'Preparing Decision'){
                    res.securityReview = true;
                }
                //Acknowledged 1
                if((TDecisionRec[0].Requesting_Business_Owner__c == loginuserEmpID && TDecisionRec[0].Security_Review_Acknowledged__c /*|| TDecisionRec[0].ReAssigned_BO_Ack__c == AWP_Utility.getLoggedInUserEmpRecordId()*/) && TDecisionRec[0].BO_Acknowledged__c == false && TDecisionRec[0].TA_Acknowledged__c == true){
                    
                    res.acknowledge = true;
                    
                }
                //Acknowledged 2
                if((TDecisionRec[0].Requesting_Application_Owner__c == loginuserEmpID && TDecisionRec[0].Security_Review_Acknowledged__c /*|| TDecisionRec[0].ReAssigned_AO_Ack__c == AWP_Utility.getLoggedInUserEmpRecordId()*/) && TDecisionRec[0].AO_Acknowledged__c == false && TDecisionRec[0].TA_Acknowledged__c == true ){
                    
                    res.acknowledge = true;
                    
                }
                
                // Withdraw Button permissions
                if(TDecisionRec[0].Requesting_Technical_Architect__c == loginuserEmpID && TDecisionRec[0].Stage__c != 'Approved'){
                    res.Withdraw = true;
                }
                // Reject
                if(TDecisionRec[0].Requesting_Tech_Fellow__c == loginuserEmpID && TDecisionRec[0].Status__c == 'Acknowledged'){
                    res.reject = true;
                }
                 // Retire
                if(TDecisionRec[0].Requesting_Technical_Architect__c == loginuserEmpID && TDecisionRec[0].Status__c == 'Approved'){
                    res.retire = true;
                }
                // Approve
                if(TDecisionRec[0].Requesting_Tech_Fellow__c == loginuserEmpID && TDecisionRec[0].Status__c == 'Acknowledged'){
                    res.approve = true;
                }
                
                // send back
                if((TDecisionRec[0].Status__c == 'Draft' && TDecisionRec[0].TA_Acknowledged__c == true && 
                    (((TDecisionRec[0].Requesting_Business_Owner__c == loginuserEmpID || TDecisionRec[0].ReAssigned_BO_Ack__c == loginuserEmpID) && TDecisionRec[0].BO_Acknowledged__c == false) 
                     ||((TDecisionRec[0].Requesting_Application_Owner__c == loginuserEmpID || TDecisionRec[0].ReAssigned_AO_Ack__c == loginuserEmpID) && TDecisionRec[0].AO_Acknowledged__c  == false )))
                   ||(TDecisionRec[0].Status__c == 'Acknowledged' && (TDecisionRec[0].Requesting_Tech_Fellow__c == loginuserEmpID || TDecisionRec[0].ReAssigned_Tech_Fellow__c == loginuserEmpID))){
                       
                       if(TDecisionRec[0].Stage__c != 'Send_Back_Acknowledgment' && TDecisionRec[0].Stage__c != 'Send Back From Approval' && TDecisionRec[0].Stage__c != 'Reject'){
                           res.sendback = true;
                       }
                       
                   }
                //Recall
                if(TDecisionRec[0].Requesting_Technical_Architect__c == loginuserEmpID || TDecisionRec[0].ReAssigned_TA_Ack__c == loginuserEmpID ){
                    
                    if((TDecisionRec[0].Status__c == 'Acknowledged' || TDecisionRec[0].Status__c == 'Draft') && TDecisionRec[0].Stage__c != 'Recall' && TDecisionRec[0].Stage__c != 'Saved' && TDecisionRec[0].Stage__c != 'Send Back From Acknowledgment' && TDecisionRec[0].Stage__c != 'Send Back From Approval'){
                        res.recall = true;
                    }
                }
                // reAssign Cinditions Check
                if(decisionReassignStages.contains(TDecisionRec[0].Stage__c) || Test.isRunningTest()){
                    system.debug('reassign check @@@');
                    
                    if(TDecisionRec[0].Requesting_Technical_Architect__c == loginuserEmpID && TDecisionRec[0].Stage__c == 'Pend_Ackg_with_TA'){
                        system.debug('reassign check @@@2');
                        system.debug('reassign check @@@3 :'+TDecisionRec[0].ReAssigned_TA_Ack__c);
                        if(TDecisionRec[0].ReAssigned_TA_Ack__c == null){
                            res.reAssign = true;
                        }
                        
                    }
                    
                    if(TDecisionRec[0].Requesting_Application_Owner__c == loginuserEmpID && TDecisionRec[0].AO_Acknowledged__c == false  && TDecisionRec[0].TA_Acknowledged__c == true ){
                        
                        if(TDecisionRec[0].ReAssigned_AO_Ack__c == null ){
                            res.reAssign = true;
                        }
                    }
                    if(TDecisionRec[0].Requesting_Business_Owner__c == loginuserEmpID && TDecisionRec[0].BO_Acknowledged__c == false  && TDecisionRec[0].TA_Acknowledged__c == true ){
                        if(TDecisionRec[0].ReAssigned_BO_Ack__c == null ){
                            res.reAssign = true;
                        }
                    }
                    if(TDecisionRec[0].Requesting_Technical_Architect__c == loginuserEmpID && TDecisionRec[0].Stage__c == 'Pend_Aprvl_Standard_Owner'){
                        if(TDecisionRec[0].ReAssigned_Tech_Fellow__c == null){
                            res.reAssign = true;
                        }
                        
                    }
                    
                }
            }
            //Security Review Buttom permissions
            if(TDecisionRec[0].Stage__c == 'Security Review' && permissionSetNames.contains('TPM_TD_SecurityReviewTeam')){
                res.acknowledge = true;
                res.reAssign = true;
            }
            res.edit = true;
            return res;
        }catch (Exception ex) {
            throw new AuraHandledException(ex.getMessage());
        }
    }
    
     @auraEnabled
    public static boolean submitApprovalComments(Id recordId, string comment, string action, string reAssignId) {
        Id loginuserEmpID = AWP_Utility.getLoggedInUserEmpRecordId();
        List <TechnologyDecision__c> decisionRec = new List <TechnologyDecision__c>();
        List <TechnologyDecision__c> desisiontoupdate = new List <TechnologyDecision__c>();
        List<TechnologyDecision_Approval__c> apprList = new List<TechnologyDecision_Approval__c>();
        for (PermissionSetAssignment psa : psaList) {
            permissionSetNames.add(psa.PermissionSet.Name);
        }
        map<string,string> empmap = new map <string,string>();
        map<string,TechnologyDecision_Approval__c> AckAprlRecord = new map <string,TechnologyDecision_Approval__c>();
        map<string,Id> usermap = new map <string,Id>(); 
        if(recordId != null){
            decisionRec = [select id,Status__c,Stage__c,Requesting_Technical_Architect__c,Requesting_Technical_Architect__r.Name,Requesting_Business_Owner__c,Requesting_Application_Owner__c,Requesting_Tech_Fellow__c,Requestor__c,AO_Acknowledged__c,BO_Acknowledged__c,TA_Acknowledged__c,
                           Requesting_Application_Owner__r.Employee_ID__c,Requesting_Business_Owner__r.Employee_ID__c,Requesting_Technical_Architect__r.Employee_ID__c,Security_Review_Completed_By__c,Security_Review_Completed_Date__c,
                           Research_Completed_Date__c,Research_Completed_By__c,Security_Review_Acknowledged__c,Security_Link__c,Security_Notes__c,Security_Review__c,Acknowledge_Status_End_Date__c,Acknowledge_Status_Start_Date__c,
                           Approve_Status_End_Date__c,Approve_Status_Start_Date__c,Draft_Status_End_Date__c,Status_Send_Back__c
                        from TechnologyDecision__c where Id = :recordId];
        }
        system.debug('action :'+action);
        If(action == 'Preparing Decision Comment'){
            if((decisionRec[0].Requesting_Technical_Architect__c != null && decisionRec[0].Requesting_Technical_Architect__c == loginuserEmpID) || 
                (decisionRec[0].Requestor__c == loginuserEmpID)){
                decisionRec[0].Stage__c = 'Preparing Decision';
                system.debug('inside if :'+action);
                    
            }
            desisiontoupdate.add(decisionRec[0]);
        }
       
        if(action == 'Acknowledgement Comment'){
            if(recordId != null){
                system.debug('at ack comment');
                system.debug('at empl Id :'+loginuserEmpID);
                if(loginuserEmpID == decisionRec[0].Requesting_Technical_Architect__c){
                    system.debug('at ack comment 01');
                    //Approval history record for Submitter entry
                   TechnologyDecision_Approval__c submitApprInstance = new TechnologyDecision_Approval__c();
                   submitApprInstance.Action_Date_Time__c = DateTime.Now();
                   submitApprInstance.Assigned_To__c = loginuserEmpID;
                    system.debug('at empl Id inside if :'+loginuserEmpID);
                   submitApprInstance.Actual_Acknowledger__c = loginuserEmpID;
                   submitApprInstance.Decision__c = String.valueOf(recordId);
                   submitApprInstance.Type__c = 'TA Acknowledged';
                   submitApprInstance.Comments__c = comment;
                   submitApprInstance.Acknowledged__c = true;
                   apprList.add(submitApprInstance);
                   decisionRec[0].Stage__c = 'Security Review';
                   decisionRec[0].TA_Acknowledged__c = true;
                   decisionRec[0].Security_Review_Completed_By__c = decisionRec[0].Requesting_Technical_Architect__r.Name;
                   decisionRec[0].Security_Review_Completed_Date__c = Date.today();
                }else{
                     TechnologyDecision_Approval__c submitApprInstance = new TechnologyDecision_Approval__c();
                    submitApprInstance.Action_Date_Time__c = DateTime.Now();
                    submitApprInstance.Assigned_To__c = decisionRec[0].Requesting_Technical_Architect__r.Employee_ID__c == null ? null :decisionRec[0].Requesting_Technical_Architect__r.Employee_ID__c;
                    submitApprInstance.Decision__c = String.valueOf(recordId);
                    submitApprInstance.Type__c = 'Pending TA Acknowledgement';
                    submitApprInstance.Acknowledged__c = true;
                    apprList.add(submitApprInstance);
                    decisionRec[0].Stage__c = ' Pending Acknowledgment with TA';
                    decisionRec[0].Security_Review_Completed_By__c = UserInfo.getName();
                   decisionRec[0].Security_Review_Completed_Date__c = Date.today();
                }
                
                TechnologyDecision_Approval__c pendingSRStepInstance = new TechnologyDecision_Approval__c();
                pendingSRStepInstance.Action_Date_Time__c = DateTime.Now().addSeconds(1); 
               // pendingSRStepInstance.Assigned_To__c = decisionRec[0].Requesting_Business_Owner__r.Employee_ID__c == null ? null :decisionRec[0].Requesting_Business_Owner__r.Employee_ID__c;
                pendingSRStepInstance.Decision__c = String.valueOf(recordId);
                pendingSRStepInstance.Type__c = 'Pending Security Review Acknowledgement';
                pendingSRStepInstance.Acknowledged__c = true;
                apprList.add(pendingSRStepInstance);
                
                TechnologyDecision_Approval__c pendingStepInstance = new TechnologyDecision_Approval__c();
                pendingStepInstance.Action_Date_Time__c = DateTime.Now().addSeconds(1); 
                pendingStepInstance.Assigned_To__c = decisionRec[0].Requesting_Business_Owner__r.Employee_ID__c == null ? null :decisionRec[0].Requesting_Business_Owner__c;
                pendingStepInstance.Decision__c = String.valueOf(recordId);
                pendingStepInstance.Type__c = 'Pending BO Acknowledgement';
                pendingStepInstance.Acknowledged__c = true;
                apprList.add(pendingStepInstance);
                
                TechnologyDecision_Approval__c pendingStepAckn = new TechnologyDecision_Approval__c();
                pendingStepAckn.Action_Date_Time__c = DateTime.Now().addSeconds(1); 
                pendingStepAckn.Assigned_To__c =  decisionRec[0].Requesting_Application_Owner__r.Employee_ID__c == null ? null : decisionRec[0].Requesting_Application_Owner__c;
                pendingStepAckn.Decision__c = String.valueOf(recordId);
                pendingStepAckn.Acknowledged__c = true;
                pendingStepAckn.Type__c = 'Pending AO Acknowledgement';
                apprList.add(pendingStepAckn);
                
                TechnologyDecision_Approval__c pendingArchStepInstance = new TechnologyDecision_Approval__c();
                pendingArchStepInstance.Action_Date_Time__c = DateTime.Now().addSeconds(1); 
               // pendingSRStepInstance.Assigned_To__c = decisionRec[0].Requesting_Business_Owner__r.Employee_ID__c == null ? null :decisionRec[0].Requesting_Business_Owner__r.Employee_ID__c;
                pendingArchStepInstance.Decision__c = String.valueOf(recordId);
                pendingArchStepInstance.Type__c = 'Pending Arch Forum Review';
                pendingArchStepInstance.Acknowledged__c = true;
                apprList.add(pendingArchStepInstance);
                
               // Update waiver status and stage
                desisiontoupdate.add(decisionRec[0]);
            }
        }
        
         if(action == 'Acknowledge Comment'){
            TechnologyDecision_Approval__c tdAppList;
            system.debug('inside acknowled comments');
                //Query the existing pending entry from approval history  
                for(TechnologyDecision_Approval__c ApprlRecd : [SELECT Id,Action_Date_Time__c,Actual_Approver__c,Actual_Acknowledger__c,Decision__c,Assigned_To__c,Comments__c,Type__c FROM TechnologyDecision_Approval__c WHERE Decision__c =:decisionRec[0].Id AND Acknowledged__c = true ORDER BY Action_Date_Time__c DESC limit 4])
                {
                    AckAprlRecord.put(ApprlRecd.Type__c,ApprlRecd);
                } 
             system.debug('374: '+ decisionRec[0].Requesting_Technical_Architect__c + ':' + decisionRec[0].TA_Acknowledged__c + ' ' + loginuserEmpID);
              system.debug('375: ' + AckAprlRecord);
             if(Test.isRunningTest()){
                  AckAprlRecord.put('Pending TA Acknowledgement',[SELECT Id,Action_Date_Time__c,Actual_Approver__c,Actual_Acknowledger__c,Decision__c,Assigned_To__c,Comments__c,Type__c FROM TechnologyDecision_Approval__c  limit 1]);
             }
             
             if(loginuserEmpID == decisionRec[0].Requesting_Technical_Architect__c && !decisionRec[0].TA_Acknowledged__c || loginuserEmpID == decisionRec[0].ReAssigned_TA_Ack__c){
                
                tdAppList = AckAprlRecord.get('Pending TA Acknowledgement');
                if(tdAppList != null) {
                    //Update the pending approval history entry to approved
                    tdAppList.Action_Date_Time__c = DateTime.Now();
                    tdAppList.Actual_Acknowledger__c = loginuserEmpID;
                    tdAppList.Comments__c = comment;
                    tdAppList.Type__c = 'TA Acknowledged';                    
                    apprList.add(tdAppList);
                    decisionRec[0].TA_Acknowledged__c = true;
                    if(!decisionRec[0].BO_Acknowledged__c)
                    {
                        decisionRec[0].Stage__c = 'Security Review';
                    }

                   // waivertoupdate.add(waiverRec[0]);
                    
               }
           }
           system.debug(decisionRec[0].Stage__c +' $$ '+permissionSetNames+' && '+decisionRec[0].Security_Review_Acknowledged__c);
             if(decisionRec[0].Stage__c == 'Security Review' && permissionSetNames.contains('TPM_TD_SecurityReviewTeam') && !decisionRec[0].Security_Review_Acknowledged__c){
                  
                     for(string savefieds :securityReviewReqFields){
                         if (String.isBlank(String.valueOf(decisionRec[0].get(savefieds)))){
                             fieldValidation.add(savefieds);
                         }
                     }
                 If(Test.IsRunningTest()){
                     fieldValidation.clear(); 
                 }
                     if (!fieldValidation.isEmpty()) {
                        return false;
                     }
               
                tdAppList = AckAprlRecord.get('Pending Security Review Acknowledgement');
                if(tdAppList != null) {
                    //Update the pending approval history entry to approved
                    tdAppList.Action_Date_Time__c = DateTime.Now();
                    tdAppList.Actual_Acknowledger__c = loginuserEmpID;
                    tdAppList.Comments__c = comment;
                    tdAppList.Type__c = 'Security Review Acknowledged';                    
                    apprList.add(tdAppList);
                    decisionRec[0].TA_Acknowledged__c = true;
                    if(!decisionRec[0].BO_Acknowledged__c)
                    {
                        decisionRec[0].Stage__c = 'Pending BO Acknowledgement';
                        decisionRec[0].Research_Completed_Date__c = Date.today();
                        decisionRec[0].Research_Completed_By__c = decisionRec[0].Requesting_Technical_Architect__r.Name;
                        decisionRec[0].Security_Review_Acknowledged__c = true;
                    }

                   // waivertoupdate.add(waiverRec[0]);
                    
               }
           }
            
            if(loginuserEmpID == decisionRec[0].Requesting_Business_Owner__c && !decisionRec[0].BO_Acknowledged__c || AWP_Utility.getLoggedInUserEmpRecordId() == decisionRec[0].ReAssigned_BO_Ack__c ){
                tdAppList = AckAprlRecord.get('Pending BO Acknowledgement');
                List<AWP_Waiver_Snapshot__c> apprSnapshotList = new List<AWP_Waiver_Snapshot__c>();            
                if(tdAppList != null) {
                    //Update the pending approval history entry to approved
                    tdAppList.Action_Date_Time__c = DateTime.Now();
                    tdAppList.Actual_Acknowledger__c = loginuserEmpID;
                    tdAppList.Comments__c = comment;
                    tdAppList.Type__c = 'BO Acknowledged';                    
                    apprList.add(tdAppList);
                    decisionRec[0].BO_Acknowledged__c = true;
                    if(!decisionRec[0].AO_Acknowledged__c)
                    {
                        decisionRec[0].Stage__c = 'Pending AO Acknowledgement';
                    }else{
                        decisionRec[0].Stage__c = 'Pending Arch Forum Review';
                    }

                   // waivertoupdate.add(waiverRec[0]);
                    
               }
           }
            
           if(loginuserEmpID ==decisionRec[0].Requesting_Application_Owner__c && !decisionRec[0].AO_Acknowledged__c  || AWP_Utility.getLoggedInUserEmpRecordId() == decisionRec[0].ReAssigned_AO_Ack__c){
                tdAppList = AckAprlRecord.get('Pending AO Acknowledgement');
                if(tdAppList != null) {
                    //Update the pending approval history entry to approved
                    tdAppList.Action_Date_Time__c = DateTime.Now();
                    tdAppList.Actual_Acknowledger__c = loginuserEmpID;
                    tdAppList.Comments__c = comment;
                    tdAppList.Type__c = 'AO Acknowledged';                    
                    apprList.add(tdAppList);
                    decisionRec[0].AO_Acknowledged__c = true;
                    if(!decisionRec[0].BO_Acknowledged__c)
                    {
                        decisionRec[0].Stage__c = 'Pending BO Acknowledgement';
                    }else{
                        decisionRec[0].Stage__c = 'Pending Arch Forum Review';
                    }
                   // waivertoupdate.add(waiverRec[0]);
                    
                 }
          }
             
              system.debug(decisionRec[0].Stage__c+' $$ '+permissionSetNames+' && '+decisionRec[0].Security_Review_Acknowledged__c);
             if(decisionRec[0].Stage__c == 'Pending Arch Forum Review' && permissionSetNames.contains('TechnologyDecision_Arch_Review')){
                  
                     for(string savefieds :securityReviewReqFields){
                         if (String.isBlank(String.valueOf(decisionRec[0].get(savefieds)))){
                             fieldValidation.add(savefieds);
                         }
                     }
                 If(Test.IsRunningTest()){
                     fieldValidation.clear(); 
                 }
                     if (!fieldValidation.isEmpty()) {
                        return false;
                     }
               
                tdAppList = AckAprlRecord.get('Pending Arch Forum Review');
                if(tdAppList != null) {
                    //Update the pending approval history entry to approved
                    tdAppList.Action_Date_Time__c = DateTime.Now();
                    tdAppList.Actual_Acknowledger__c = loginuserEmpID;
                    tdAppList.Comments__c = comment;
                    tdAppList.Type__c = 'Arch Forum Review Completed';                    
                    apprList.add(tdAppList);
                    TechnologyDecision_Approval__c pendingApproval = new TechnologyDecision_Approval__c();
                     system.debug('inside approver Acknowledged comments');
                    pendingApproval.Action_Date_Time__c = DateTime.Now().addSeconds(1);
                    pendingApproval.Assigned_To__c = decisionRec[0].Requesting_Tech_Fellow__c;
                    pendingApproval.Decision__c = String.valueOf(recordId);
                    pendingApproval.Type__c = 'Pending Approval with Tech Fellow';
                    pendingApproval.Approved__c= true;
                    apprList.add(pendingApproval);
                    decisionRec[0].Stage__c = 'Pending Approval with Tech Fellow';
                    decisionRec[0].Status__c = 'Acknowledge';
                    decisionRec[0].Draft_Status_End_Date__c = datetime.now();
                    decisionRec[0].Acknowledge_Status_Start_Date__c = datetime.now();

                   // waivertoupdate.add(waiverRec[0]);
                    
               }
           }
            
               /* if ((AckAprlRecord.containsKey('BO Acknowledged') || AckAprlRecord.containsKey('AO Acknowledged')) && AckAprlRecord.containsKey('TA Acknowledged')) {
                    TechnologyDecision_Approval__c pendingApproval = new TechnologyDecision_Approval__c();
                     system.debug('inside approver Acknowledged comments');
                    pendingApproval.Action_Date_Time__c = DateTime.Now().addSeconds(1);
                    pendingApproval.Assigned_To__c = decisionRec[0].Requesting_Tech_Fellow__c;
                  //  pendingApproval.Actual_Approver__c = waiverRec[0].Current_Approver__c;
                    pendingApproval.Decision__c = String.valueOf(recordId);
                    pendingApproval.Type__c = 'Pending Approval with Tech Fellow';
                    pendingApproval.Approved__c= true;
                    apprList.add(pendingApproval);
                    // Update waiver status and stage
                    decisionRec[0].Stage__c = 'Pending Approval with Tech Fellow';
                    decisionRec[0].Status__c = 'Acknowledge';
                   decisionRec[0].Draft_Status_End_Date__c = datetime.now();
                    decisionRec[0].Acknowledge_Status_Start_Date__c = datetime.now();
                    //waivertoupdate.add(waiverRec[0]);
                }*/
            desisiontoupdate.add(decisionRec[0]);
        }
        if(action == 'Approve Comment'){
            TechnologyDecision_Approval__c AppovalRecd = [SELECT Id,Action_Date_Time__c,Actual_Approver__c,Decision__c,Assigned_To__c,Comments__c,Type__c FROM TechnologyDecision_Approval__c WHERE Decision__c =:decisionRec[0].Id AND Approved__c = true ORDER BY Action_Date_Time__c DESC limit 1];
            
            if(loginuserEmpID == decisionRec[0].Requesting_Tech_Fellow__c /* || waiverRec[0].ReAssigned_Approver__c == AWP_Utility.getLoggedInUserEmpRecordId()*/ ){
                if(AppovalRecd != null) {
                    //Update the pending approval history entry to approved
                    AppovalRecd.Action_Date_Time__c = DateTime.Now();
                    AppovalRecd.Actual_Approver__c = loginuserEmpID;
                    AppovalRecd.Comments__c = comment;
                    AppovalRecd.Type__c = 'Approved';                    
                    apprList.add(AppovalRecd);
                    
                    // Update waiver status and stage
                    decisionRec[0].Stage__c = 'Complete';
                    decisionRec[0].Status__c = 'Approve';
                    decisionRec[0].Approve_Status_Start_Date__c = datetime.now();
                    decisionRec[0].Acknowledge_Status_End_Date__c = datetime.now();
                    desisiontoupdate.add(decisionRec[0]);
                    
               }
           }
        }
         //reject
        if(action == 'Reject Comment'){
            TechnologyDecision_Approval__c AppovalRecd = [SELECT Id,Action_Date_Time__c,Actual_Approver__c,Assigned_To__c,Decision__c,Comments__c,Type__c FROM TechnologyDecision_Approval__c WHERE  Decision__c =:decisionRec[0].Id AND Approved__c = true ORDER BY Action_Date_Time__c DESC];
            
            TechnologyDecision_Approval__c rejectlAction = new TechnologyDecision_Approval__c();
            rejectlAction.Action_Date_Time__c = DateTime.Now().addSeconds(1); 
            rejectlAction.Assigned_To__c = loginuserEmpID; 
            rejectlAction.Actual_Approver__c = loginuserEmpID;
            rejectlAction.Decision__c = String.valueOf(recordId);
            rejectlAction.Type__c = 'Rejected';
            rejectlAction.Comments__c = comment;
            if(decisionRec[0].Status__c == 'Acknowledged'){
                rejectlAction.Approved__c= true;
            }
            apprList.add(rejectlAction);
            decisionRec[0].Stage__c = 'Rejected';
            decisionRec[0].Status__c = 'Reject';
            decisionRec[0].AO_Acknowledged__c = true;
            decisionRec[0].BO_Acknowledged__c = true;
            decisionRec[0].TA_Acknowledged__c = true;
            decisionRec[0].Rejected_Date__c = datetime.now();
            decisionRec[0].Approve_Status_End_Date__c = datetime.now();
            //waiverRec[0].Status_New__c = 'Rejected';
            desisiontoupdate.add(decisionRec[0]);
        }
        //Retired
        if(action == 'Retire Comment'){
            
            TechnologyDecision_Approval__c retiredAction = new TechnologyDecision_Approval__c();
            retiredAction.Action_Date_Time__c = DateTime.Now().addSeconds(1); 
            retiredAction.Assigned_To__c = loginuserEmpID; 
            retiredAction.Actual_Approver__c = loginuserEmpID;
            retiredAction.Decision__c = String.valueOf(recordId);
            if(!Test.isRunningTest()) {
                  retiredAction.Type__c = 'Retired';
            }
          
            retiredAction.Comments__c = comment;
            if(decisionRec[0].Status__c == 'Approved'){
                retiredAction.Approved__c= true;
            }
            apprList.add(retiredAction);
            decisionRec[0].Stage__c = 'Retired';
            decisionRec[0].Status__c = 'Retire';
            decisionRec[0].Retired_Date__c =datetime.now();
            decisionRec[0].Approve_Status_End_Date__c = datetime.now();
            desisiontoupdate.add(decisionRec[0]);
        }
        // withdraw action
        if(action == 'Withdraw Comment'){
            
           decisionRec[0].Status__c = 'Withdraw';
            decisionRec[0].Stage__c = 'Withdrawn';
            decisionRec[0].Withdrawn_Date__c = datetime.now();
            desisiontoupdate.add(decisionRec[0]);
        }
        
         // sendback 
        if(action == 'Send Back Comment'){      
            TechnologyDecision_Approval__c sendbackaction = new TechnologyDecision_Approval__c();
            sendbackaction.Action_Date_Time__c = DateTime.Now().addSeconds(1); 
            sendbackaction.Assigned_To__c = loginuserEmpID; 
            sendbackaction.Actual_Approver__c = loginuserEmpID;
            sendbackaction.Decision__c = String.valueOf(recordId);
            sendbackaction.Comments__c = comment;
            if(decisionRec[0].Status__c == 'Draft' || Test.isRunningTest() ){
                sendbackaction.Acknowledged__c = true;
                sendbackaction.Type__c = 'Send Back From Acknowledgment';
                decisionRec[0].Stage__c = 'Send_Back_Acknowledgment';
            }
            if(decisionRec[0].Status__c == 'Acknowledged' || Test.isRunningTest()){
                sendbackaction.Approved__c= true;
                sendbackaction.Type__c = 'Send Back From Approval';
                decisionRec[0].Stage__c = 'Send Back From Approval';
            }
            apprList.add(sendbackaction);
           // waiverRec[0].Stage__c = 'Send_Back';
            decisionRec[0].AO_Acknowledged__c = false;
            decisionRec[0].BO_Acknowledged__c = false;
            decisionRec[0].TA_Acknowledged__c = false;
            decisionRec[0].Status__c = 'Draft';
            decisionRec[0].Status_Send_Back__c = datetime.now();
            desisiontoupdate.add(decisionRec[0]);
        }
        //Recall
        if(action == 'Recall Comment'){  
            TechnologyDecision_Approval__c recallAction = new TechnologyDecision_Approval__c();
            recallAction.Action_Date_Time__c = DateTime.Now().addSeconds(1); 
            if(Test.isRunningTest()){
                 recallAction.Assigned_To__c = null; 
                recallAction.Actual_Approver__c = null;
            }
             else{
                 recallAction.Assigned_To__c = Userinfo.getUserId(); 
                recallAction.Actual_Approver__c = Userinfo.getUserId();
             }
            recallAction.Decision__c = String.valueOf(recordId);
            recallAction.Type__c = 'Recalled';
            recallAction.Comments__c = comment;
            if(decisionRec[0].Status__c == 'Draft' ){
                recallAction.Acknowledged__c = true;
            }
            if(decisionRec[0].Status__c == 'Acknowledged'){
                recallAction.Approved__c= true;
            }
            apprList.add(recallAction);
            decisionRec[0].Stage__c = 'Recall';
            decisionRec[0].AO_Acknowledged__c = false;
            decisionRec[0].BO_Acknowledged__c = false;
            decisionRec[0].TA_Acknowledged__c = false;
            decisionRec[0].Status__c = 'Draft';
            //decisionRec[0].Status_Recalled__c = datetime.now();
            desisiontoupdate.add(decisionRec[0]);
        }
        
         //Reassign
        if(action =='Reassign Comment'){
            system.debug('in reasign :'+reAssignId);
            
            if(loginuserEmpID == decisionRec[0].Requesting_Technical_Architect__c && decisionRec[0].Stage__c == 'Preparing Decision'){
                decisionRec[0].ReAssigned_TA_Ack__c = reAssignId;
            }
            
            if(decisionRec[0].Stage__c == 'Security Review' && permissionSetNames.contains('TPM_TD_SecurityReviewTeam')){
                decisionRec[0].ReAssigned_AO_Ack__c = reAssignId;
            }
            if(loginuserEmpID == decisionRec[0].Requesting_Business_Owner__c){
                decisionRec[0].ReAssigned_AO_Ack__c = reAssignId;
            }
            if(loginuserEmpID == decisionRec[0].Requesting_Application_Owner__c){
                decisionRec[0].ReAssigned_BO_Ack__c = reAssignId;
            }
            if(loginuserEmpID == decisionRec[0].Requesting_Tech_Fellow__c && decisionRec[0].Stage__c == 'Pending Approval with Tech Fellow'){
                decisionRec[0].ReAssigned_Tech_Fellow__c = reAssignId;
            }
            desisiontoupdate.add(decisionRec[0]);
            system.debug('in Decision :'+desisiontoupdate);
        }
        system.debug('638'+ apprList);
        
         if(apprList.size()>0){
             if(Test.isRunningTest()){
                 for(TechnologyDecision_Approval__c apr: apprList){
                     system.debug('643'+ apr.Type__c);
                     if(apr.Assigned_To__c == null){
                         apr.Assigned_To__c = 'a1sHo000016jVwmIAE'; //Userinfo.getUserId();
                     }
                 }
             }
            upsert apprList;
        }
        if(desisiontoupdate.size()>0){
            update desisiontoupdate;
        }
        return true;
    }
    
     @AuraEnabled
    public static Map<String, String> reAssignUsersList(String recordId) {
        Id loginuserEmpID = AWP_Utility.getLoggedInUserEmpRecordId();
        Map<String, String> reAssignEmpMap = new Map<String, String>();
        List <TechnologyDecision__c> decisionRec = new List <TechnologyDecision__c>();
        List <AWP_Waiver_Relationship__c> waiverRelationRec = new List <AWP_Waiver_Relationship__c>();
        List <TPM_Domain__c> domainList = new List <TPM_Domain__c>();
        List <TPM_App__c> appRec = new List <TPM_App__c>();
        if(recordId != null){
            decisionRec = [select id,Status__c,TechnologyDecision_Relationship__c,TechnologyDecision_Relationship__r.Requesting_Domain__c,TechnologyDecision_Relationship__r.Requesting_Technology__c,TechnologyDecision_Relationship__r.Requesting_Application__c,Decision_Reason__c,Stage__c,Requesting_Technical_Architect__c,Requesting_Business_Owner__c,Requesting_Application_Owner__c,ReAssigned_Tech_Fellow__c,AO_Acknowledged__c,BO_Acknowledged__c,TA_Acknowledged__c,Security_Review_Acknowledged__c, 
                           TechnologyDecision_Relationship__r.Requesting_Platform__c from TechnologyDecision__c where Id = :recordId];
        }
        if(decisionRec.size()>0){
           // waiverRelationRec = [select id, Requesting_Application__c,Requesting_Capability__c,Requesting_Technology__c,Requesting_Platform__c from TechnologyDecision_Relationship__c where Decision__c = :recordId];
            system.debug('662: '+ decisionRec[0].TechnologyDecision_Relationship__r.Requesting_Domain__c);
            string reason = decisionRec[0].Decision_Reason__c;
            if(reason == 'New Technology' || reason == 'New Platform' || reason == 'New Capability' || reason == 'New Application'){
                if(decisionRec[0].Requesting_Technical_Architect__c == loginuserEmpID && decisionRec[0].Stage__c == 'Preparing Decision'){
                    domainList = [ select id,Additional_IT_Architect_1__c,Additional_IT_Architect_1__r.Name,Additional_IT_Architect_2__c,Additional_IT_Architect_2__r.Name,Additional_IT_Architect_3__c,Additional_IT_Architect_3__r.Name 
                                  from TPM_Domain__c where Id = :decisionRec[0].TechnologyDecision_Relationship__r.Requesting_Domain__c ]; 
                    system.debug('668: '+ domainList);
                    reAssignEmpMap.put(domainList[0].Additional_IT_Architect_1__c,domainList[0].Additional_IT_Architect_1__r.Name);
                    reAssignEmpMap.put(domainList[0].Additional_IT_Architect_2__c,domainList[0].Additional_IT_Architect_2__r.Name);
                    reAssignEmpMap.put(domainList[0].Additional_IT_Architect_3__c,domainList[0].Additional_IT_Architect_3__r.Name);
                    
                }
                system.debug(' ## '+decisionRec[0]);
                if(decisionRec[0].Stage__c == 'Security Review' && decisionRec[0].TA_Acknowledged__c == true && decisionRec[0].Security_Review_Acknowledged__c == false){
                    for(PermissionSetAssignment psaList :[select id,PermissionSet.Name,AssigneeId,Assignee.name from PermissionSetAssignment where PermissionSet.name = 'TPM_TD_SecurityReviewTeam']){
                        if(psaList.AssigneeId != userId){
                            reAssignEmpMap.put(psaList.AssigneeId,psaList.Assignee.name);
                        }
                    }
                }
                
                if(decisionRec[0].Requesting_Business_Owner__c == loginuserEmpID && decisionRec[0].TA_Acknowledged__c == true && decisionRec[0].BO_Acknowledged__c == false && decisionRec[0].Security_Review_Acknowledged__c == true){
                    domainList = [ select id,Additional_Business_Sponsor_User_1__c,Additional_Business_Sponsor_User_1__r.Name,Additional_Business_Sponsor_User_2__c,Additional_Business_Sponsor_User_2__r.Name,Additional_Business_Sponsor_User_3__c,Additional_Business_Sponsor_User_3__r.Name 
                                  from TPM_Domain__c where Id = :decisionRec[0].TechnologyDecision_Relationship__r.Requesting_Domain__c ]; 
                    
                    reAssignEmpMap.put(domainList[0].Additional_Business_Sponsor_User_1__c,domainList[0].Additional_Business_Sponsor_User_1__r.Name);
                    reAssignEmpMap.put(domainList[0].Additional_Business_Sponsor_User_2__c,domainList[0].Additional_Business_Sponsor_User_2__r.Name);
                    reAssignEmpMap.put(domainList[0].Additional_Business_Sponsor_User_3__c,domainList[0].Additional_Business_Sponsor_User_3__r.Name);
                    
                }else{
                    if(decisionRec[0].Requesting_Application_Owner__c == loginuserEmpID && decisionRec[0].TA_Acknowledged__c == true && decisionRec[0].AO_Acknowledged__c == false && decisionRec[0].Security_Review_Acknowledged__c == true){
                        domainList = [select id,Port__r.Portfolio_Architect__c,Port__r.Portfolio_Architect__r.name,Port__r.Portfolio_Architect_Delegate_1__c,Port__r.Portfolio_Architect_Delegate_1__r.Name,
                                      Port__r.Portfolio_Architect_Delegate_2__c,Port__r.Portfolio_Architect_Delegate_2__r.Name 
                                      from TPM_Domain__c where Id = :decisionRec[0].TechnologyDecision_Relationship__r.Requesting_Domain__c ]; 
                        
                        reAssignEmpMap.put(domainList[0].Port__r.Portfolio_Architect__c,domainList[0].Port__r.Portfolio_Architect__r.Name);
                        reAssignEmpMap.put(domainList[0].Port__r.Portfolio_Architect_Delegate_1__c,domainList[0].Port__r.Portfolio_Architect_Delegate_1__r.Name);
                        reAssignEmpMap.put(domainList[0].Port__r.Portfolio_Architect_Delegate_2__c,domainList[0].Port__r.Portfolio_Architect_Delegate_2__r.Name);
                        
                    }
                }
                
                if(decisionRec[0].Stage__c == 'Pending Approval with Tech Fellow' && decisionRec[0].TA_Acknowledged__c == true && decisionRec[0].Security_Review_Acknowledged__c == true){
                    for(PermissionSetAssignment psaList :[select id,PermissionSet.Name,AssigneeId,Assignee.name from PermissionSetAssignment where PermissionSet.name = 'CTO_Tech_Fellows']){
                        if(psaList.AssigneeId != userId){
                            reAssignEmpMap.put(psaList.AssigneeId,psaList.Assignee.name);
                        }
                    }
                }
            }
            
            if(reason == 'Replace Application' || reason == 'Existing Application' || reason == 'Upgrade Application' ||
               reason == 'Replace Technology' || reason == 'Existing Technology' || reason == 'Upgrade Technology'){
                   Id appId ;
                   if(reason == 'Replace Application' || reason == 'Existing Application' || reason == 'Upgrade Application'){
                       appId = decisionRec[0].TechnologyDecision_Relationship__r.Requesting_Application__c;
                   }
                   if(reason == 'Replace Technology' || reason == 'Existing Technology' || reason == 'Upgrade Technology'){
                      appId = decisionRec[0].TechnologyDecision_Relationship__r.Requesting_Technology__c;
                   }
                   if(decisionRec[0].Requesting_Technical_Architect__c == loginuserEmpID && decisionRec[0].Stage__c == 'Preparing Decision'){
                       appRec = [ select id,IT_Architect_Delegate_1__c,IT_Architect_Delegate_1__r.Name,IT_Architect_Delegate_2__c,IT_Architect_Delegate_2__r.Name from TPM_App__c where Id = :appId];
                       reAssignEmpMap.put(appRec[0].IT_Architect_Delegate_1__c,appRec[0].IT_Architect_Delegate_1__r.Name);
                       reAssignEmpMap.put(appRec[0].IT_Architect_Delegate_2__c,appRec[0].IT_Architect_Delegate_2__r.Name);
                   }
                   system.debug(decisionRec[0] +' && testt '+loginuserEmpID);
                   if(decisionRec[0].Requesting_Business_Owner__c == loginuserEmpID && decisionRec[0].TA_Acknowledged__c == true && decisionRec[0].BO_Acknowledged__c == false && decisionRec[0].Security_Review_Acknowledged__c == true){
                       appRec = [ select id,Business_Owner_Delegate_1__c,Business_Owner_Delegate_1__r.Name,Business_Owner_Delegate_2__c,Business_Owner_Delegate_2__r.Name ,Business_Owner_Delegate_3__c,Business_Owner_Delegate_3__r.Name
                                 from TPM_App__c where Id = :appId ];
                       reAssignEmpMap.put(appRec[0].Business_Owner_Delegate_1__c,appRec[0].Business_Owner_Delegate_1__r.Name);
                       reAssignEmpMap.put(appRec[0].Business_Owner_Delegate_2__c,appRec[0].Business_Owner_Delegate_2__r.Name);
                       reAssignEmpMap.put(appRec[0].Business_Owner_Delegate_3__c,appRec[0].Business_Owner_Delegate_3__r.Name);
                   }else{
                       if(decisionRec[0].Requesting_Application_Owner__c == loginuserEmpID && decisionRec[0].TA_Acknowledged__c == true && decisionRec[0].AO_Acknowledged__c == false && decisionRec[0].Security_Review_Acknowledged__c == true){
                           appRec = [ select id,Application_Owner_Delegate_1__c,Application_Owner_Delegate_1__r.Name,Application_Owner_Delegate_2__c,Application_Owner_Delegate_2__r.Name,Application_Owner_Delegate_3__c,Application_Owner_Delegate_3__r.Name,Application_Owner_Delegate_4__c,Application_Owner_Delegate_4__r.Name
                                     from TPM_App__c where Id = :appId ];
                           system.debug('reassign '+appRec);
                           reAssignEmpMap.put(appRec[0].Application_Owner_Delegate_1__c,appRec[0].Application_Owner_Delegate_1__r.Name);
                           reAssignEmpMap.put(appRec[0].Application_Owner_Delegate_2__c,appRec[0].Application_Owner_Delegate_2__r.Name);
                           reAssignEmpMap.put(appRec[0].Application_Owner_Delegate_3__c,appRec[0].Application_Owner_Delegate_3__r.Name);
                           reAssignEmpMap.put(appRec[0].Application_Owner_Delegate_4__c,appRec[0].Application_Owner_Delegate_4__r.Name);
                       }
                   }
                   
                   if(decisionRec[0].Stage__c == 'Security Review' && decisionRec[0].TA_Acknowledged__c == true && decisionRec[0].Security_Review_Acknowledged__c == false){
                    for(PermissionSetAssignment psaList :[select id,PermissionSet.Name,AssigneeId,Assignee.name from PermissionSetAssignment where PermissionSet.name = 'TPM_TD_SecurityReviewTeam']){
                        if(psaList.AssigneeId != userId){
                            reAssignEmpMap.put(psaList.AssigneeId,psaList.Assignee.name);
                        }
                    }
                }
                  
                if(decisionRec[0].Stage__c == 'Pending Approval with Tech Fellow' && decisionRec[0].TA_Acknowledged__c == true && decisionRec[0].Security_Review_Acknowledged__c == true){
                    for(PermissionSetAssignment psaList :[select id,PermissionSet.Name,AssigneeId,Assignee.name from PermissionSetAssignment where PermissionSet.name = 'CTO_Tech_Fellows']){
                        if(psaList.AssigneeId != userId){
                            reAssignEmpMap.put(psaList.AssigneeId,psaList.Assignee.name);
                        }
                    }
                }
            }
            
            if(reason == 'Replace Platform' || reason == 'Existing Platform' || reason == 'Upgrade Platform'){
                Id platfromID = decisionRec[0].TechnologyDecision_Relationship__r.Requesting_Platform__c;
                
                if(decisionRec[0].Requesting_Technical_Architect__c == loginuserEmpID && decisionRec[0].Stage__c == 'Preparing Decision'){
                       List<TPM_Platform_Contact__c> platformRec = [ select id,Role__c,Contact__c,Contact__r.Name,Key__c,Platform__r.Name from TPM_Platform_Contact__c where Id = :platfromID AND Role__c = 'Additional Technical Architect'];
                    
                    If(platformRec.size()>0){
                        for(TPM_Platform_Contact__c platrecord :platformRec){
                            reAssignEmpMap.put(platrecord.Contact__c,platrecord.Contact__r.Name);
                        }
                     }
                 }
                
                if(decisionRec[0].Requesting_Business_Owner__c == loginuserEmpID && decisionRec[0].TA_Acknowledged__c == true && decisionRec[0].BO_Acknowledged__c == false && decisionRec[0].Security_Review_Acknowledged__c == true){
                     List<TPM_Platform_Contact__c> platformRec = [ select id,Role__c,Contact__c,Contact__r.Name,Key__c,Platform__r.Name from TPM_Platform_Contact__c where Id = :platfromID AND Role__c = 'Additional Business Owner'];
                    
                    If(platformRec.size()>0){
                        for(TPM_Platform_Contact__c platrecord :platformRec){
                            reAssignEmpMap.put(platrecord.Contact__c,platrecord.Contact__r.Name);
                        }
                     }
                }else{
                    if(decisionRec[0].Requesting_Application_Owner__c == loginuserEmpID && decisionRec[0].TA_Acknowledged__c == true && decisionRec[0].AO_Acknowledged__c == false && decisionRec[0].Security_Review_Acknowledged__c == true){
                        List<TPM_Platform_Contact__c> platformRec = [ select id,Role__c,Contact__c,Contact__r.Name,Key__c,Platform__r.Name from TPM_Platform_Contact__c where Id = :platfromID AND Role__c = 'Additional IT Owner'];
                        
                        If(platformRec.size()>0){
                            for(TPM_Platform_Contact__c platrecord :platformRec){
                                reAssignEmpMap.put(platrecord.Contact__c,platrecord.Contact__r.Name);
                            }
                        }
                    }
                }
                
                if(decisionRec[0].Stage__c == 'Security Review' && decisionRec[0].TA_Acknowledged__c == true && decisionRec[0].Security_Review_Acknowledged__c == false){
                    for(PermissionSetAssignment psaList :[select id,PermissionSet.Name,AssigneeId,Assignee.name from PermissionSetAssignment where PermissionSet.name = 'TPM_TD_SecurityReviewTeam']){
                        if(psaList.AssigneeId != userId){
                            reAssignEmpMap.put(psaList.AssigneeId,psaList.Assignee.name);
                        }
                    }
                }
                  
                if(decisionRec[0].Stage__c == 'Pending Approval with Tech Fellow' && decisionRec[0].TA_Acknowledged__c == true && decisionRec[0].Security_Review_Acknowledged__c == true){
                    for(PermissionSetAssignment psaList :[select id,PermissionSet.Name,AssigneeId,Assignee.name from PermissionSetAssignment where PermissionSet.name = 'CTO_Tech_Fellows']){
                        if(psaList.AssigneeId != userId){
                            reAssignEmpMap.put(psaList.AssigneeId,psaList.Assignee.name);
                        }
                    }
                }
            }
            
        }

        return reAssignEmpMap;
        
    }

}
