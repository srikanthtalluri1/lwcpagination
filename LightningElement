  // --- seed ---
    private static void seed() {
        // 4 records cover Approved/Draft + null/non-null Decision_Reason__c + varied Stage
        insert new List<TechnologyDecision__c>{
            new TechnologyDecision__c(Name='Alpha TD',  Status__c='Approved', Stage__c='Init',   Decision_Reason__c='Cost'),
            new TechnologyDecision__c(Name='Bravo TD',  Status__c='Approved', Stage__c='Review'),                  // null reason
            new TechnologyDecision__c(Name='Charlie',   Status__c='Approved', Stage__c='Final',  Decision_Reason__c='Risk'),
            new TechnologyDecision__c(Name='Delta TD',  Status__c='Draft',    Stage__c='Init',   Decision_Reason__c='Scope')
        };
    }

    // --- 1) Basic path (no filters/search) + implicit Approved gate if user lacks RO permset ---
    @IsTest
    static void t_getTechDecision_basic() {
        seed();
        Test.startTest();
        Map<String,Object> res = TechnologyDecision_DataTableHandler.getTechnologyDecision(0, 200, null, 'alldecision', null);
        Test.stopTest();
        System.assertNotEquals(null, res);
        System.assert(res.containsKey('decisionRecords') && res.containsKey('decisionRecordsCount'));
        List<TechnologyDecision__c> rows = (List<TechnologyDecision__c>)res.get('decisionRecords');
        System.assert(rows.size() > 0, 'Should return some rows');
    }

    // --- 2) Search path (LIKE on Name/Stage/Status/Decision_Reason) ---
    @IsTest
    static void t_getTechDecision_searchLike() {
        seed();
        Test.startTest();
        Map<String,Object> res = TechnologyDecision_DataTableHandler.getTechnologyDecision(0, 50, null, 'alldecision', 'Alpha');
        Test.stopTest();
        System.assert(res.get('decisionRecords') != null);
        List<TechnologyDecision__c> rows = (List<TechnologyDecision__c>)res.get('decisionRecords');
        System.assert(rows.size() >= 1, 'Search should match Alpha TD');
    }

    // --- 3) Filters → ONLY nullcheck (should build "= NULL" for that field) ---
    @IsTest
    static void t_getTechDecision_filter_onlyNullCheck() {
        seed();
        String filters = JSON.serialize(new List<Object>{
            new Map<String,Object>{ 'Decision Reason' => new List<Object>{ 'nullcheck' } }
        });
        Test.startTest();
        Map<String,Object> res = TechnologyDecision_DataTableHandler.getTechnologyDecision(0, 200, filters, 'alldecision', null);
        Test.stopTest();
        System.assertNotEquals(null, res);
        // executes the branch building "(field = NULL)" and closes/parens cleanup
    }

    // --- 4) Filters → values + nullcheck (IN (...) OR = NULL) + another field filter ---
    @IsTest
    static void t_getTechDecision_filter_valuesAndNull() {
        seed();
        String filters = JSON.serialize(new List<Object>{
            new Map<String,Object>{ 'Decision Reason' => new List<Object>{ 'Risk', 'nullcheck' } },
            new Map<String,Object>{ 'Stage' => new List<Object>{ 'Final', 'Review' } }
        });
        Test.startTest();
        Map<String,Object> res = TechnologyDecision_DataTableHandler.getTechnologyDecision(0, 200, filters, 'alldecision', null);
        Test.stopTest();
        System.assert(res.containsKey('decisionRecordsCount'));
    }

    // --- 5) Filters present but produce no clauses → triggers the "(" → cleanup branch ---
    @IsTest
    static void t_getTechDecision_filter_emptyArrayCleanup() {
        seed();
        // Empty list yields no field conditions; last char '(' branch should run and wipe filterQuery
        String filters = JSON.serialize(new List<Object>{
            new Map<String,Object>{ 'Status' => new List<Object>{} }
        });
        Test.startTest();
        Map<String,Object> res = TechnologyDecision_DataTableHandler.getTechnologyDecision(0, 200, filters, 'alldecision', null);
        Test.stopTest();
        System.assertNotEquals(null, res);
    }

    // --- 6) "mydecision" path: adds OwnerId (for getUniqueValues) and the AWP_Utility bound vars are still evaluated ---
    @IsTest
    static void t_getUniqueValues_all_and_my() {
        seed();

        // Reassign one record to the running user so my-bucket has at least something
        TechnologyDecision__c one = [SELECT Id FROM TechnologyDecision__c WHERE Name = 'Alpha TD' LIMIT 1];
        update new TechnologyDecision__c(Id = one.Id, OwnerId = UserInfo.getUserId());

        List<String> ask = new List<String>{ 'Status', 'Stage', 'Decision Reason' };

        Test.startTest();
        Map<String,Object> allMap = TechnologyDecision_DataTableHandler.getUniqueValues(ask, 'alldecision');
        Map<String,Object> myMap  = TechnologyDecision_DataTableHandler.getUniqueValues(ask, 'mydecision');
        Test.stopTest();

        System.assert(allMap.containsKey('Status') && myMap.containsKey('Status'));
        System.assert(((List<Object>)allMap.get('Status')).size() > 0);
        System.assert(((List<Object>)myMap.get('Status')).size() > 0, 'My bucket should have something due to reassignment');
    }

    // --- 7) Label→API resolver (safe assertion; just ensure it executes) ---
    @IsTest
    static void t_getApiNamesFromLabels_executes() {
        Test.startTest();
        List<String> s1 = TechnologyDecision_DataTableHandler.getApiNamesFromLabels('TechnologyDecision__c', 'Status');
        List<String> s2 = TechnologyDecision_DataTableHandler.getApiNamesFromLabels('TechnologyDecision__c', 'Stage');
        List<String> s3 = TechnologyDecision_DataTableHandler.getApiNamesFromLabels('TechnologyDecision__c', 'Decision Reason');
        Test.stopTest();
        System.assertNotEquals(null, s1);
        System.assertNotEquals(null, s2);
        System.assertNotEquals(null, s3);
    }
