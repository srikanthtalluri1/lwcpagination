import { LightningElement, api, track } from 'lwc';
import getFieldValue from '@salesforce/apex/LookupController.getFieldValue';
import searchRecords from '@salesforce/apex/LookupController.searchRecords';

export default class LookupComponent extends LightningElement {

    @api readOnly;

    @api label;
    @api iconName = 'standard:account';
    @api relationShipObjectName;
    @api relationShipFieldName;
    @api objectName;
    @api fieldName;
    @api displayField = 'Name';
    @api recordId;
    @track displayValue = '';  // Field to hold the display name
    @track searchResults = [];
    @track showDropdown = false;
    @track noResults = false;

    connectedCallback() {
        if (this.recordId) {
            this.fetchCurrentRecord();
        }
    }

    // Fetch the current value based on recordId, objectName, fieldName, and displayField
    async fetchCurrentRecord() {
        try {
            const result = await getFieldValue({
                recordId: this.recordId,
                objectName: this.objectName,
                fieldName: this.fieldName,
                displayField: this.displayField
            });
            this.displayValue = result ? result : 'No related record';
        } catch (error) {
            console.error('Error fetching current record:', error);
        }
    }

    // Handle user input for search
    handleSearchInput(event) {
        const searchTerm = event.target.value;
        if (searchTerm.length >= 2) {
            this.performSearch(searchTerm);
        } else {
            this.searchResults = [];
            this.noResults = false;
            this.showDropdown = false;
        }
    }

    // Perform search using an Apex method
    async performSearch(searchTerm) {
        try {
            const results = await searchRecords({
                objectName: this.relationShipObjectName,
                fieldName: this.relationShipFieldName,
                searchTerm,
                displayField: this.displayField
            });
            this.searchResults = results;
            //this.noResults = results.length === 0;
            this.showDropdown = results.length > 0;
        } catch (error) {
            console.error('Error searching records:', error);
        }
    }

    // Handle selection from dropdown
    handleSelect(event) {
        const recordId = event.currentTarget.dataset.id;
        const selectedRecord = this.searchResults.find(record => record.id === recordId);
        this.displayValue = selectedRecord.name;
        this.showDropdown = false;

        // Dispatch event to parent component with selected record id
        this.dispatchEvent(new CustomEvent('select', { detail: { recordId } }));
    }

    // Toggle dropdown visibility
    toggleDropdown() {
        this.showDropdown = !this.showDropdown;
    }

    // Clear the selection and reset search
    clearSelection() {
        this.displayValue = '';  // Clear the display value
        this.searchResults = [];  // Clear the search results
        this.noResults = false;  // Reset the 'No results found' message
        this.showDropdown = false;  // Close the dropdown
        this.dispatchEvent(new CustomEvent('clear'));  // Dispatch 'clear' event
    }
}
