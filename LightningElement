public class TechnologyDecision_HistoryHandler {

    @AuraEnabled(cacheable=true)
    public static List<WrapperClass> getHistoryRecords(Id decisionId) {
        // Always return something (even if empty)
        if (decisionId == null) {
            return new List<WrapperClass>();
        }

        // --- Get parent TechnologyDecision__c ---
        TechnologyDecision__c decision = [
            SELECT CreatedDate, CreatedBy.Name, CreatedById, TechnologyDecision_Relationship__c  
            FROM TechnologyDecision__c  
            WHERE Id = :decisionId 
            LIMIT 1
        ];

        // --- Try to get related TechnologyDecision_Relationship__c ---
        TechnologyDecision_Relationship__c rel;
        try {
            rel = [
                SELECT Id, CreatedDate, CreatedBy.Name, CreatedById  
                FROM TechnologyDecision_Relationship__c 
                WHERE Id = :decision.TechnologyDecision_Relationship__c 
                LIMIT 1
            ];
        } catch (Exception e) {
            rel = null;
        }

        // --- Query real history rows (may be empty in tests) ---
        List<TechnologyDecision__History> decisionHistory = [
            SELECT Field, OldValue, NewValue, CreatedDate, CreatedBy.Name, CreatedById
            FROM TechnologyDecision__History
            WHERE ParentId = :decisionId
        ];

        List<TechnologyDecision_Relationship__History> relationshipHistory =
            (rel == null)
            ? new List<TechnologyDecision_Relationship__History>()
            : [
                SELECT Field, OldValue, NewValue, CreatedDate, CreatedBy.Name, CreatedById
                FROM TechnologyDecision_Relationship__History
                WHERE ParentId = :rel.Id
            ];

        // Heavy logic moved to a helper so tests can inject fake history data
        return buildHistoryRecords(decisionHistory, relationshipHistory);
    }

    /**
     * Core logic that converts history rows to WrapperClass.
     * Marked @TestVisible so tests can pass in mock history rows (since real history
     * rows are not created during unit tests).
     */
    @TestVisible
    static List<WrapperClass> buildHistoryRecords(
        List<TechnologyDecision__History> decisionHistory,
        List<TechnologyDecision_Relationship__History> relationshipHistory
    ) {
        List<WrapperClass> historyRecords = new List<WrapperClass>();

        // Cache describe map once
        Map<String, Schema.SObjectField> mfields =
            Schema.TechnologyDecision__c.SObjectType.getDescribe().fields.getMap();

        // ---- Decision history ----
        for (TechnologyDecision__History formHistory : decisionHistory) {
            String oldValue = String.valueOf(formHistory.OldValue);
            String newValue = String.valueOf(formHistory.NewValue);
            String fieldLabel = formHistory.Field;

            if (formHistory.Field != null && mfields.containsKey(formHistory.Field)) {
                Schema.DescribeFieldResult fieldResult = mfields.get(formHistory.Field).getDescribe();
                fieldLabel = fieldResult.getLabel();
            }

            // Special logic for Status picklist: convert API value to label
            if (fieldLabel == 'Status') {
                if (formHistory.OldValue != null) {
                    oldValue = getPicklistLabel(
                        'TechnologyDecision__c',
                        'Status__c',
                        String.valueOf(formHistory.OldValue)
                    );
                }
                if (formHistory.NewValue != null) {
                    newValue = getPicklistLabel(
                        'TechnologyDecision__c',
                        'Status__c',
                        String.valueOf(formHistory.NewValue)
                    );
                }
            }

            historyRecords.add(new WrapperClass(
                fieldLabel,
                oldValue,
                newValue,
                formHistory.CreatedDate,
                (formHistory.CreatedBy == null ? null : formHistory.CreatedBy.Name),
                String.valueOf(formHistory.CreatedById),
                'AWP Architecture Waiver Form'
            ));
        }

        // ---- Relationship history ----
        if (relationshipHistory != null) {
            for (TechnologyDecision_Relationship__History relationshipHistoryRow : relationshipHistory) {
                historyRecords.add(new WrapperClass(
                    relationshipHistoryRow.Field,
                    String.valueOf(relationshipHistoryRow.OldValue),
                    String.valueOf(relationshipHistoryRow.NewValue),
                    relationshipHistoryRow.CreatedDate,
                    (relationshipHistoryRow.CreatedBy == null ? null : relationshipHistoryRow.CreatedBy.Name),
                    String.valueOf(relationshipHistoryRow.CreatedById),
                    'TechnologyDecision Relationship'
                ));
            }
        }

        // Sort descending by createdDate
        historyRecords.sort(new WrapperComparator());
        return historyRecords;
    }

    public static String getPicklistLabel(String objectApiName, String fieldApiName, String apiValue) {
        if (String.isBlank(objectApiName) || String.isBlank(fieldApiName) || String.isBlank(apiValue)) {
            return null;
        }

        Schema.SObjectType objType = Schema.getGlobalDescribe().get(objectApiName);
        if (objType == null) return null;

        Schema.DescribeSObjectResult objDescribe = objType.getDescribe();
        Schema.SObjectField field = objDescribe.fields.getMap().get(fieldApiName);
        if (field == null) return null;

        List<Schema.PicklistEntry> picklistValues = field.getDescribe().getPicklistValues();
        for (Schema.PicklistEntry entry : picklistValues) {
            if (entry.getValue() == apiValue) {
                return entry.getLabel();
            }
        }
        return null; // no match found
    }

    public class WrapperComparator implements Comparator<WrapperClass> {
        public Integer compare(WrapperClass a, WrapperClass b) {
            if (b.createdDate > a.createdDate) {
                return 1;  // Sort in descending order
            } else if (b.createdDate < a.createdDate) {
                return -1;
            } else {
                return 0;  // Same date
            }
        }
    }

    @AuraEnabled(cacheable=true)
    public static List<TechnologyDecision__History> getWaiverFormHistoryRecords(Id decisionId) {
        List<TechnologyDecision__History> waiver = [
            SELECT Field, OldValue, NewValue, CreatedDate, CreatedBy.Name, CreatedById
            FROM TechnologyDecision__History
            WHERE ParentId = :decisionId
        ];
        return waiver;
    }

    public class WrapperClass {
        @AuraEnabled public String fieldName;
        @AuraEnabled public String oldValue;
        @AuraEnabled public String newValue;
        @AuraEnabled public Datetime createdDate;
        @AuraEnabled public String createdBy;
        @AuraEnabled public String createdById;
        @AuraEnabled public String source;

        public WrapperClass(
            String fieldName,
            String oldValue,
            String newValue,
            Datetime createdDate,
            String createdBy,
            String createdById,
            String source
        ) {
            this.fieldName = fieldName;
            this.oldValue = oldValue;
            this.newValue = newValue;
            this.createdDate = createdDate;
            this.createdBy = createdBy;
            this.createdById = createdById;
            this.source = source;
        }
    }
}
