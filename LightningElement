@IsTest
private class technologyDecision_CreateFormHelpers_Test {

    // ---------- Dynamic test-factory helpers ----------
    class TDTestData {
        static Map<String, Schema.SObjectType> gd = Schema.getGlobalDescribe();

        static Boolean exists(String objApi) {
            return gd.containsKey(objApi);
        }

        // Create any sObject dynamically from api name and fields. Returns inserted Id or null.
        static Id upsertDyn(String objApi, Map<String, Object> fields) {
            if (!exists(objApi)) return null;
            SObject sob = gd.get(objApi).newSObject();
            for (String k : fields.keySet()) sob.put(k, fields.get(k));
            insert sob;
            return sob.getId();
        }

        // Create TechnologyDecision_Relationship__c and return Id
        static Id makeRelation(
            Id domainId,
            Id techId,
            Id appId,
            Id platformId,
            Map<String, Object> extra
        ) {
            if (!exists('TechnologyDecision_Relationship__c')) return null;
            Map<String, Object> f = new Map<String, Object>{
                'Requesting_Domain__c'      => domainId,
                'Requesting_Technology__c'  => techId,
                'Requesting_Application__c' => appId,
                'Requesting_Platform__c'    => platformId
            };
            if (extra != null) f.putAll(extra);
            return upsertDyn('TechnologyDecision_Relationship__c', f);
        }

        // Create TechnologyDecision__c (returns Id)
        static Id makeDecision(Map<String,Object> f) {
            return upsertDyn('TechnologyDecision__c', f);
        }

        // Create TechnologyDecision_Approval__c
        static Id makeApproval(Map<String,Object> f) {
            return upsertDyn('TechnologyDecision_Approval__c', f);
        }

        // Domain/App/Platform/Platform Contact dynamically (if exist)
        static Id makeDomain(Map<String,Object> f)   { return upsertDyn('TPM_Domain__c', f); }
        static Id makeApp(Map<String,Object> f)      { return upsertDyn('TPM_App__c', f); }
        static Id makePlatform(Map<String,Object> f) { return upsertDyn('TPM_Platform__c', f); }
        static Id makePlatformContact(Map<String,Object> f) { return upsertDyn('TPM_Platform_Contact__c', f); }

        // An "Employee" record (adjust object api if needed)
        static Id makeEmployee(String name) {
            if (!exists('AWP_Employee__c')) return null;
            return upsertDyn('AWP_Employee__c', new Map<String,Object>{ 'Name' => name });
        }

        static void injectPerms(List<String> names) {
            for (String n : names) {
                if (!technologyDecision_CreateFormHelpers.permissionSetNames.contains(n)) {
                    technologyDecision_CreateFormHelpers.permissionSetNames.add(n);
                }
            }
        }
    }

    // Optional seam usage (safe even if seam not present in prod class)
    static void setLoginEmp(Id empId) {
        try {
            technologyDecision_CreateFormHelpers.TEST_loginUserEmpIdOverride = empId;
        } catch (Exception e) {
            // If seam not added, ignore; tests still run (fewer branches may execute)
        }
    }

    // ---------- TOP-LEVEL HELPER (moved out of test method) ----------
    // Build a TechnologyDecision__c for reAssignUsersList tests
    private static Id mkTD(
        Id relId, Id empTA, Id empBO, Id empAO, Id empTF,
        String reason, String stage, Boolean taAck, Boolean boAck, Boolean aoAck, Boolean secAck
    ) {
        Map<String,Object> f = new Map<String,Object>{
            'Name'                              => 'TD-' + reason + '-' + stage,
            'Decision_Reason__c'                => reason,
            'Stage__c'                          => stage,
            'Status__c'                         => (stage == 'Pending Approval with Tech Fellow' ? 'Acknowledged' : 'Draft'),
            'TechnologyDecision_Relationship__c'=> relId,
            'Requesting_Technical_Architect__c' => empTA,
            'Requesting_Business_Owner__c'      => empBO,
            'Requesting_Application_Owner__c'   => empAO,
            'Requesting_Tech_Fellow__c'         => empTF,
            'TA_Acknowledged__c'                => taAck,
            'BO_Acknowledged__c'                => boAck,
            'AO_Acknowledged__c'                => aoAck,
            'Security_Review_Acknowledged__c'   => secAck
        };
        return TDTestData.makeDecision(f);
    }

    // ------------- TESTS -------------

    @IsTest
    static void test_createDecisionWithRelation_success() {
        Id domainId = TDTestData.makeDomain(new Map<String,Object>{ 'Name' => 'Payments' });
        Id appId    = TDTestData.makeApp(new Map<String,Object>{ 'Name' => 'Core App' });
        Id platId   = TDTestData.makePlatform(new Map<String,Object>{ 'Name' => 'Core Platform' });

        Map<String, Object> relationFields = new Map<String, Object>{
            'Requesting_Domain__c'      => domainId,
            'Requesting_Application__c' => appId,
            'Requesting_Platform__c'    => platId
        };

        Map<String, Object> decisionFields = new Map<String, Object>{
            'Name'      => 'TD-001',
            'Why__c'    => 'Save Cost',
            'What__c'   => 'Adopt New Tool',
            'Value__c'  => 'High',
            'Stage__c'  => 'Saved',
            'Status__c' => 'Draft'
        };

        String idStr = technologyDecision_CreateFormHelpers.createDecisionWithRelation(decisionFields, relationFields);
        System.assertNotEquals(null, idStr, 'Decision Id should be returned');

        if (TDTestData.exists('TechnologyDecision_Relationship__c')) {
            TechnologyDecision_Relationship__c rel =
                [SELECT Id, Decison_Id__c
                 FROM TechnologyDecision_Relationship__c
                 WHERE Decison_Id__c = :Id.valueOf(idStr) LIMIT 1];
            System.assertNotEquals(null, rel, 'Relation should point to the Decision');
        }
    }

    @IsTest
    static void test_getDecisionRecord() {
        Id tdId = TDTestData.makeDecision(new Map<String,Object>{
            'Name' => 'TD-READ', 'Stage__c' => 'Saved', 'Status__c'=> 'Draft'
        });
        if (tdId == null) return;

        TechnologyDecision__c got = technologyDecision_CreateFormHelpers.getDecisionRecord(tdId);
        System.assertEquals(tdId, got.Id, 'Should fetch same record');
    }

    @IsTest
    static void test_validateRequiredFieldsOnDecision_allStages() {
        // Saved: Missing Why/What/Value -> expect message
        Id tdSaved = TDTestData.makeDecision(new Map<String,Object>{
            'Name' => 'TD-SAVED', 'Stage__c' => 'Saved', 'Status__c'=> 'Draft'
        });
        if (tdSaved == null) return;

        String msg1 = technologyDecision_CreateFormHelpers.validateRequiredFieldsOnDecision(String.valueOf(tdSaved));
        System.assert(msg1 != null && msg1.contains('required field'), 'Should flag required fields for Saved');

        // Preparing Decision: research fields required
        Id tdPrep = TDTestData.makeDecision(new Map<String,Object>{
            'Name' => 'TD-PREP', 'Stage__c' => 'Preparing Decision', 'Status__c'=> 'Draft',
            'Why__c' => 'Y', 'What__c' => 'W', 'Value__c' => 'V'
        });
        String msg2 = technologyDecision_CreateFormHelpers.validateRequiredFieldsOnDecision(String.valueOf(tdPrep));
        System.assert(msg2 != null && msg2.contains('Security Review'), 'Should flag research fields for Preparing Decision');

        // Security Review: security fields required
        Id tdSec = TDTestData.makeDecision(new Map<String,Object>{
            'Name' => 'TD-SEC', 'Stage__c' => 'Security Review', 'Status__c'=> 'Draft',
            'Why__c'=>'Y','What__c'=>'W','Value__c'=>'V',
            'Research_Notes__c' => 'n','Research_Link__c' => 'http://x',
            'Decision_Summary__c' => 's','Decision_Notes__c' => 'n'
        });
        String msg3 = technologyDecision_CreateFormHelpers.validateRequiredFieldsOnDecision(String.valueOf(tdSec));
        System.assert(msg3 != null && msg3.contains('Security Review Acknowledgement'), 'Should flag security fields for Security Review');
    }

    @IsTest
    static void test_fetchButtonPermissions_with_and_without_perms() {
        Id emp = TDTestData.makeEmployee('Logged In Emp');
        setLoginEmp(emp);

        TDTestData.injectPerms(new List<String>{ 'TPM_Read_Write' });

        Id tdId = TDTestData.makeDecision(new Map<String,Object>{
            'Name' => 'TD-BUTTONS', 'Stage__c' => 'Saved', 'Status__c'=> 'Draft',
            'Requesting_Technical_Architect__c' => emp, 'Requestor__c' => emp
        });
        if (tdId == null) return;

        technologyDecision_CreateFormHelpers.ButtonPermissions bp =
            technologyDecision_CreateFormHelpers.fetchButtonPermissions(String.valueOf(tdId));

        System.assertEquals(true, bp.prepareDecision, 'TA/Requestor should see Prepare Decision on Saved');
        System.assertEquals(true, bp.edit, 'Edit is always enabled');

        // Now simulate no perms
        technologyDecision_CreateFormHelpers.permissionSetNames.clear();
        bp = technologyDecision_CreateFormHelpers.fetchButtonPermissions(String.valueOf(tdId));
        System.assertEquals(true, bp.edit, 'Edit remains enabled even without named perms');
    }

    @IsTest
    static void test_submitApprovalComments_fullMatrix() {
        Id empTA = TDTestData.makeEmployee('TA');
        Id empBO = TDTestData.makeEmployee('BO');
        Id empAO = TDTestData.makeEmployee('AO');
        Id empTF = TDTestData.makeEmployee('TechFellow');
        setLoginEmp(empTA);

        TDTestData.injectPerms(new List<String>{
            'TPM_Read_Write','TPM_TD_SecurityReviewTeam','CTO_Tech_Fellows'
        });

        Id tdId = TDTestData.makeDecision(new Map<String,Object>{
            'Name' => 'TD-APPROVAL',
            'Stage__c' => 'Saved', 'Status__c'=> 'Draft',
            'Requestor__c' => empTA,
            'Requesting_Technical_Architect__c' => empTA,
            'Requesting_Business_Owner__c'      => empBO,
            'Requesting_Application_Owner__c'   => empAO,
            'Requesting_Tech_Fellow__c'         => empTF
        });
        if (tdId == null) return;

        // 1) Preparing Decision Comment
        System.assertEquals(true,
            technologyDecision_CreateFormHelpers.submitApprovalComments(tdId, 'prep', 'Preparing Decision Comment', null));
        TechnologyDecision__c td =
            [SELECT Id, Stage__c FROM TechnologyDecision__c WHERE Id = :tdId];
        System.assertEquals('Preparing Decision', td.Stage__c);

        // 2) Acknowledgement Comment
        System.assertEquals(true,
            technologyDecision_CreateFormHelpers.submitApprovalComments(tdId, 'ack now', 'Acknowledgement Comment', null));
        td = [SELECT Id, Stage__c FROM TechnologyDecision__c WHERE Id = :tdId];
        System.assert(td.Stage__c.contains('Security') || td.Stage__c.contains('Pending'),
                      'Should route into security review/TA pending');

        // 3) Security Review Acknowledge path
        setLoginEmp(empTA);
        System.assertEquals(true,
            technologyDecision_CreateFormHelpers.submitApprovalComments(tdId, 'sec-ack', 'Acknowledge Comment', null));

        // 4) BO acknowledge
        setLoginEmp(empBO);
        System.assertEquals(true,
            technologyDecision_CreateFormHelpers.submitApprovalComments(tdId, 'bo-ack', 'Acknowledge Comment', null));

        // 5) AO acknowledge
        setLoginEmp(empAO);
        System.assertEquals(true,
            technologyDecision_CreateFormHelpers.submitApprovalComments(tdId, 'ao-ack', 'Acknowledge Comment', null));

        // Should be pending TF approval now
        td = [SELECT Id, Stage__c, Status__c FROM TechnologyDecision__c WHERE Id = :tdId];
        System.assert(td.Stage__c.contains('Pending Approval'), 'Should be pending approval with Tech Fellow');

        // 6) Approve
        setLoginEmp(empTF);
        System.assertEquals(true,
            technologyDecision_CreateFormHelpers.submitApprovalComments(tdId, 'approve it', 'Approve Comment', null));
        td = [SELECT Id, Stage__c FROM TechnologyDecision__c WHERE Id = :tdId];
        System.assertEquals('Complete', td.Stage__c);

        // 7) Reject (reset to Acknowledged)
        update new TechnologyDecision__c(Id = tdId, Status__c = 'Acknowledged', Stage__c = 'Pending Approval with Tech Fellow');
        setLoginEmp(empTF);
        System.assertEquals(true,
            technologyDecision_CreateFormHelpers.submitApprovalComments(tdId, 'nope', 'Reject Comment', null));

        // 8) Retire (when Approved)
        update new TechnologyDecision__c(Id = tdId, Status__c = 'Approved', Stage__c = 'Complete');
        setLoginEmp(empTA);
        System.assertEquals(true,
            technologyDecision_CreateFormHelpers.submitApprovalComments(tdId, 'retire', 'Retire Comment', null));

        // 9) Withdraw
        update new TechnologyDecision__c(Id = tdId, Status__c = 'Draft', Stage__c = 'Preparing Decision');
        System.assertEquals(true,
            technologyDecision_CreateFormHelpers.submitApprovalComments(tdId, 'withdraw', 'Withdraw Comment', null));

        // 10) Send Back (Draft then Acknowledged)
        update new TechnologyDecision__c(Id = tdId, Status__c = 'Draft', Stage__c = 'Security Review');
        System.assertEquals(true,
            technologyDecision_CreateFormHelpers.submitApprovalComments(tdId, 'sendback', 'Send Back Comment', null));
        update new TechnologyDecision__c(Id = tdId, Status__c = 'Acknowledged', Stage__c = 'Pending Approval with Tech Fellow');
        System.assertEquals(true,
            technologyDecision_CreateFormHelpers.submitApprovalComments(tdId, 'sendback2', 'Send Back Comment', null));

        // 11) Recall
        update new TechnologyDecision__c(Id = tdId, Status__c = 'Draft', Stage__c = 'Security Review');
        System.assertEquals(true,
            technologyDecision_CreateFormHelpers.submitApprovalComments(tdId, 'recall', 'Recall Comment', null));

        // 12) Reassign
        update new TechnologyDecision__c(
            Id = tdId,
            Stage__c = 'Preparing Decision',
            Requesting_Technical_Architect__c = empTA,
            Requesting_Business_Owner__c      = empBO,
            Requesting_Application_Owner__c   = empAO,
            Requesting_Tech_Fellow__c         = empTF
        );
        setLoginEmp(empTA);
        System.assertEquals(true,
            technologyDecision_CreateFormHelpers.submitApprovalComments(tdId, 'reassign to X', 'Reassign Comment', UserInfo.getUserId()));
    }

    @IsTest
    static void test_reAssignUsersList_allReasons() {
        Id domainId = TDTestData.makeDomain(new Map<String,Object>{
            'Name' => 'Retail',
            'Additional_IT_Architect_1__c'       => UserInfo.getUserId(),
            'Additional_Business_Sponsor_User_1__c' => UserInfo.getUserId()
        });
        Id appId = TDTestData.makeApp(new Map<String,Object>{
            'Name' => 'WealthApp',
            'IT_Architect_Delegate_1__c'      => UserInfo.getUserId(),
            'Business_Owner_Delegate_1__c'    => UserInfo.getUserId(),
            'Application_Owner_Delegate_1__c' => UserInfo.getUserId()
        });
        Id platformId = TDTestData.makePlatform(new Map<String,Object>{ 'Name' => 'PLT' });

        Id relId = TDTestData.makeRelation(domainId, null, appId, platformId, null);

        Id empTA = TDTestData.makeEmployee('TA2');
        Id empBO = TDTestData.makeEmployee('BO2');
        Id empAO = TDTestData.makeEmployee('AO2');
        Id empTF = TDTestData.makeEmployee('TF2');

        setLoginEmp(empTA);

        Id tdNew = mkTD(relId, empTA, empBO, empAO, empTF,
                        'New Technology', 'Preparing Decision', false, false, false, false);
        if (tdNew != null) {
            Map<String,String> m = technologyDecision_CreateFormHelpers.reAssignUsersList(String.valueOf(tdNew));
            System.assertNotEquals(null, m, 'Map should be returned (may be empty)');
        }

        Id tdApp = mkTD(relId, empTA, empBO, empAO, empTF,
                        'Existing Application', 'Security Review', true, false, false, false);
        if (tdApp != null) {
            Map<String,String> m = technologyDecision_CreateFormHelpers.reAssignUsersList(String.valueOf(tdApp));
            System.assertNotEquals(null, m);
        }

        Id tdPA  = mkTD(relId, empTA, empBO, empAO, empTF,
                        'Existing Technology', 'Pending Approval with Tech Fellow', true, true, true, true);
        if (tdPA != null) {
            Map<String,String> m = technologyDecision_CreateFormHelpers.reAssignUsersList(String.valueOf(tdPA));
            System.assertNotEquals(null, m);
        }

        Id tdPlat = mkTD(relId, empTA, empBO, empAO, empTF,
                         'Replace Platform', 'Preparing Decision', false, false, false, false);
        if (tdPlat != null) {
            Map<String,String> m = technologyDecision_CreateFormHelpers.reAssignUsersList(String.valueOf(tdPlat));
            System.assertNotEquals(null, m);
        }
    }
}
