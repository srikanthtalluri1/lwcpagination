import { LightningElement, track, api, wire } from 'lwc';

export default class TechnologyDecisionCustomPick extends LightningElement {
       @track isDropdownOpen = false;
    @track searchKey = '';
    @track options = [
       // { label: 'Stage', value: 'Stage', selected: false, class: 'slds-form-element__label' },
        { label: 'Status/Stage', value: 'Status', selected: false, class: 'slds-form-element__label' },
        { label: 'Decision Reason', value: 'Decision Reason', selected: false, class: 'slds-form-element__label' }
    ];

    connectedCallback() {
        window.addEventListener('click', this.handleOutsideClick);
    }
    disconnectedCallback() {
        window.removeEventListener('click', this.handleOutsideClick);
    }

    // Keep any inside clicks from reaching window
    eatClicksInside(e) { e.stopPropagation(); }

    handleOutsideClick = (event) => {
        // Close ONLY if the click is outside this component (shadow DOM safe)
        const path = event.composedPath ? event.composedPath() : [];
        if (path.includes(this.template.host)) return;
        if (this.isDropdownOpen) this.isDropdownOpen = false;
    };
     @api
    reset() {
        this.options = this.options.map(o => ({
            ...o,
            selected: false,
            class: 'slds-form-element__label'
        }));
        this.searchKey = '';
        this.isDropdownOpen = false;
    }

    get dropdownClass() {
        return `slds-combobox slds-dropdown-trigger slds-dropdown-trigger_click ${this.isDropdownOpen ? 'slds-is-open' : ''}`;
    }

    get filteredOptions() {
        if (!this.searchKey) return this.options;
        const sk = this.searchKey.toLowerCase();
        return this.options.filter(o => o.label.toLowerCase().includes(sk));
    }

    get iconName() { return this.isDropdownOpen ? 'utility:up' : 'utility:down'; }
    get noResults() { return this.filteredOptions.length === 0; }

    // Select All states
    get isSelectAll() {
        return this.options.length > 0 && this.options.every(o => o.selected);
    }
    get isIndeterminate() {
        const any = this.options.some(o => o.selected);
        return any && !this.isSelectAll;
    }
    renderedCallback() {
        const selectAll = this.template.querySelector('lightning-input.select-all');
        if (selectAll) selectAll.indeterminate = this.isIndeterminate;
    }

    toggleDropdown(event) {
        event.stopPropagation();
        this.isDropdownOpen = !this.isDropdownOpen;
    }

    handleSearch(event) {
        event.stopPropagation();
        this.searchKey = event.target.value;
        this.isDropdownOpen = true; // keep open while typing
    }

    // Individual option click
    handleSelect(event) {
        event.stopPropagation();
        const value = event.currentTarget.dataset.value;
        this.options = this.options.map(o =>
            o.value === value
                ? { ...o, selected: !o.selected, class: !o.selected ? 'selected' : 'slds-form-element__label' }
                : o
        );
        this.fireSelectionChange();
        this.isDropdownOpen = true; // ensure it stays open after click
    }

    // Select All / Deselect All
    onSelect(event) {
        event.stopPropagation(); // don't bubble to window
        const checked = event.target.checked;
        this.options = this.options.map(o => ({
            ...o,
            selected: checked,
            class: checked ? 'selected' : 'slds-form-element__label'
        }));
        this.fireSelectionChange();
        this.isDropdownOpen = true; // stay open
    }

    fireSelectionChange() {
        const selectedValues = this.options.filter(o => o.selected).map(o => o.value);
        this.dispatchEvent(new CustomEvent('selectionchange', { detail: { values: selectedValues } }));
    }

}
