@IsTest
private class TechnologyDecisionTrigger_Tests {

    // -----------------------
    // Test data factories
    // -----------------------
    @testSetup
    static void setupData() {
        // Create minimal Users used by the relationship/requester fields.
        // If your fields point to Contact or a custom object, swap the factory accordingly.
        Profile p = [SELECT Id FROM Profile WHERE Name = 'Standard User' LIMIT 1];

        List<User> users = new List<User>();
        for (Integer i = 0; i < 6; i++) {
            users.add(new User(
                FirstName = 'U' + i,
                LastName  = 'Req',
                Alias     = 'u' + i + 'r',
                Email     = 'u' + i + 'r@example.com',
                Username  = 'u' + i + 'r' + DateTime.now().getTime() + '@example.com',
                TimeZoneSidKey = 'America/Chicago',
                LocaleSidKey   = 'en_US',
                EmailEncodingKey = 'UTF-8',
                LanguageLocaleKey = 'en_US',
                ProfileId = p.Id
            ));
        }
        insert users;

        // Relationship record that the TD will reference.
        // NOTE: If your trigger dereferences deeper (e.g., Requesting_Application__r.Application_Owner__c),
        // you can instead create that Application__c record here and point this relationship to it.
        insert new TechnologyDecision_Relationship__c(
            Name = 'Rel-1',

            // ---- These four are the values your trigger copies onto TechnologyDecision__c
            // TODO: if your source fields are different, set those here accordingly.
            Requesting_Technical_Architect__c = users[0].Id,
            Business_Owner__c                  = users[1].Id,
            Application_Owner__c               = users[2].Id,
            Tech_Fellow__c                     = users[3].Id,

            // Platform/Technology/Application specific owners (used by different reasons)
            // TODO: keep whichever your trigger actually reads.
            Requesting_Platform__IT_Owner__c   = users[4].Id,
            Requesting_Technology__IT_Owner__c = users[5].Id
        );
    }

    // -----------------------
    // Helper
    // -----------------------
    private static TechnologyDecision__c makeTD(Id relId, String reason) {
        TechnologyDecision__c td = new TechnologyDecision__c();
        td.Name = 'TD - ' + reason;
        td.Reason__c = reason; // TODO: picklist API if different
        td.TechnologyDecision_Relationship__c = relId;
        return td;
    }

    // -----------------------
    // 1) Before Insert mapping + After Insert backfill
    // -----------------------
    @IsTest
    static void test_NewTechnology_path() {
        TechnologyDecision_Relationship__c rel =
            [SELECT Id,
                    Requesting_Technical_Architect__c,
                    Business_Owner__c,
                    Application_Owner__c,
                    Tech_Fellow__c
             FROM TechnologyDecision_Relationship__c LIMIT 1];

        Test.startTest();
        TechnologyDecision__c td = makeTD(rel.Id, 'New Technology'); // one of your branches
        insert td;
        Test.stopTest();

        // After BEFORE INSERT mapping, fields should be copied on the TD
        td = [SELECT Id,
                     Reason__c,
                     Requestor__c,                       // TODO if your trigger sets this
                     Draft_Status_Start_Date__c,         // TODO if your trigger sets this
                     Requesting_Technical_Architect__c,
                     Requesting_Business_Owner__c,
                     Requesting_Application_Owner__c,
                     Requesting_Tech_Fellow__c,
                     TechnologyDecision_Relationship__c
              FROM TechnologyDecision__c
              WHERE Id = :td.Id];

        System.assertEquals('New Technology', td.Reason__c);
        System.assertEquals(rel.Requesting_Technical_Architect__c, td.Requesting_Technical_Architect__c,
                            'Tech Architect should map from relationship');
        System.assertEquals(rel.Business_Owner__c, td.Requesting_Business_Owner__c,
                            'Business Owner should map from relationship');
        System.assertEquals(rel.Application_Owner__c, td.Requesting_Application_Owner__c,
                            'App Owner should map from relationship');
        System.assertEquals(rel.Tech_Fellow__c, td.Requesting_Tech_Fellow__c,
                            'Tech Fellow should map from relationship');

        // After AFTER INSERT, relationship may be updated from TD; verify a representative field.
        TechnologyDecision_Relationship__c relAfter =
            [SELECT Id,
                    TechDecision__c,                     // TODO: replace with actual back-reference field if your trigger sets one
                    Requesting_Technical_Architect__c,
                    Business_Owner__c,
                    Application_Owner__c,
                    Tech_Fellow__c
             FROM TechnologyDecision_Relationship__c
             WHERE Id = :rel.Id];

        // If your after-insert copies values back, assert equality (kept same here).
        System.assertEquals(td.Requesting_Technical_Architect__c, relAfter.Requesting_Technical_Architect__c);
        System.assertEquals(td.Requesting_Business_Owner__c,      relAfter.Business_Owner__c);
    }

    // -----------------------
    // 2) Other reason branches (spot-check one per family)
    // -----------------------
    @IsTest
    static void test_NewPlatform_path() {
        Id relId = [SELECT Id FROM TechnologyDecision_Relationship__c LIMIT 1].Id;

        Test.startTest();
        insert makeTD(relId, 'New Platform');
        insert makeTD(relId, 'Replace Application');
        insert makeTD(relId, 'Upgrade Technology');
        insert makeTD(relId, 'Existing Application');
        Test.stopTest();

        System.assertEquals(4,
            [SELECT COUNT() FROM TechnologyDecision__c WHERE TechnologyDecision_Relationship__c = :relId],
            'Inserted four TDs across branches');
    }

    // -----------------------
    // 3) Null lookup path (no relationship) – should not blow up
    // -----------------------
    @IsTest
    static void test_NoRelationship_graceful() {
        Test.startTest();
        insert makeTD(null, 'New Application');
        Test.stopTest();

        TechnologyDecision__c td =
            [SELECT Id, TechnologyDecision_Relationship__c
             FROM TechnologyDecision__c LIMIT 1];
        System.assertEquals(null, td.TechnologyDecision_Relationship__c);
    }

    // -----------------------
    // 4) Bulk – mixed reasons, single query limits & safe DML
    // -----------------------
    @IsTest
    static void test_Bulk_200() {
        Id relId = [SELECT Id FROM TechnologyDecision_Relationship__c LIMIT 1].Id;

        List<TechnologyDecision__c> many = new List<TechnologyDecision__c>();
        List<String> reasons = new List<String>{
            'New Technology','New Platform','New Capability','New Application',
            'Replace Application','Existing Application','Upgrade Application',
            'Replace Technology','Existing Technology','Upgrade Technology',
            'Replace Platform','Existing Platform','Upgrade Platform'
        };

        for (Integer i = 0; i < 200; i++) {
            many.add(makeTD(relId, reasons[i.mod(reasons.size())]));
        }

        Test.startTest();
        insert many;
        Test.stopTest();

        System.assertEquals(200, [SELECT COUNT() FROM TechnologyDecision__c]);
    }

    // -----------------------
    // 5) Update path – ensure before/after update do not regress
    // -----------------------
    @IsTest
    static void test_Update_changes_reason() {
        Id relId = [SELECT Id FROM TechnologyDecision_Relationship__c LIMIT 1].Id;

        TechnologyDecision__c td = makeTD(relId, 'Existing Technology');
        insert td;

        td.Reason__c = 'Upgrade Technology'; // switch branch
        Test.startTest();
        update td;
        Test.stopTest();

        // No exceptions + still mapped fields present
        td = [SELECT Requesting_Technical_Architect__c FROM TechnologyDecision__c WHERE Id = :td.Id];
        System.assertNotEquals(null, td.Requesting_Technical_Architect__c);
    }
}
